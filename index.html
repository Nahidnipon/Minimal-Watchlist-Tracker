<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Media Watchlist - Lotus Garden</title>

    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      /* Lotus Garden Color Palette */
      :root {
        --primary-color: #FF857A;
        --primary-hover: #EBAEE6;
        --secondary-color: #6B403C;
        --accent-color: #ADEBB3;
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-color: #333;
      }
      /* Base reset and font */
      body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Poppins', sans-serif;
        font-size: 16px;
        min-height: 100vh;
      }
      /* Main container */
      .app-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
        min-height: 100vh;
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        position: relative;
      }
      /* HEADER */
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #e1e4e8;
        margin-bottom: 10px;
      }
      #currentTabTitle {
        font-size: 1.5rem;
        font-weight: 700;
      }
      .profile-container {
        display: inline-flex;
        align-items: center;
      }
      #profileName {
        margin-right: 10px;
        font-weight: 500;
        font-size: 0.9rem;
      }
      #profileImageContainer {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        background-color: #ddd;
      }
      #profileImageContainer img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      /* CONTENT TABS */
      .app-content {
        padding: 10px 0 80px;
      }
      .tab { display: none; }
      .tab.active-tab { display: block; }
      /* SEARCH GROUP – updated for uniform top spacing */
      .search-group {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 1rem 0;
      }
      .search-group input { flex: 7; }
      .search-group select { flex: 3; }
      /* Search results grid */
      #searchResults {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .search-card {
        border: none;
        border-radius: 8px;
        overflow: hidden;
        background: var(--card-bg);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      .search-card:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .search-card img {
        width: 100%;
        height: auto;
        display: block;
      }
      .search-card .card-body {
        padding: 5px;
      }
      .search-card .card-title {
        font-size: 1rem;
        margin: 0;
        font-weight: 500;
      }
      .search-card .card-text {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
      }
      /* Genre Capsules – "All" option added back */
      #genreCapsules {
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .badge.genre-capsule {
        background-color: var(--secondary-color) !important;
        color: #fff !important;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 20px;
      }
      .badge.genre-capsule.selected {
        background-color: var(--primary-color) !important;
      }
      /* Grid container for Popular Movies */
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
      }
      /* Horizontal carousel container */
      .carousel-container {
        display: flex;
        overflow-x: auto;
        gap: 1rem;
        padding-bottom: 0.5rem;
      }
      .carousel-container::-webkit-scrollbar { display: none; }
      /* Carousel arrow buttons – left and right */
      .carousel-wrapper { position: relative; }
      .carousel-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        background: rgba(255,255,255,0.8);
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 50%;
      }
      .carousel-arrow.left { left: 0; }
      .carousel-arrow.right { right: 0; }
      /* WATCHLIST / WATCHED CARDS – compact layout with custom buttons */
      .media-card {
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        background: var(--card-bg);
        padding: 8px;
        position: relative;
      }
      .media-card img {
        width: 70px;
        height: 105px;
        object-fit: cover;
        margin-right: 8px;
      }
      .media-card .card-body {
        padding: 4px;
      }
      .media-card .card-title {
        font-size: 0.95rem;
        margin: 0;
        font-weight: 500;
      }
      .media-card .card-text { font-size: 0.75rem; margin: 0; }
      /* Card buttons (View, Rate, Trash) for watchlist and watched */
      /* Updated Card Buttons for Watchlist and Watched Cards */
.card-buttons {
  position: absolute;
  top: 8px;  /* Increased spacing from top */
  right: 8px; /* Increased spacing from right */
  display: flex;
  gap: 6px;  /* Increased gap between buttons */
}
.card-buttons .btn {
  padding: 2px 6px;
  font-size: 0.8rem;
  line-height: 1;
  border-width: 1px;
}

/* View Button: Uses Lotus Garden accent #ADEBB3 */
.card-buttons .view-btn {
  border-color: #ADEBB3;
  color: #ADEBB3;
}
.card-buttons .view-btn:hover {
  background-color: #ADEBB3;
  color: #ffffff;
}

/* Rate Button: Default uses #EBAEE6, hover turns to #FF857A */
.card-buttons .rate-btn {
  border-color: #EBAEE6;
  color: #EBAEE6;
}
.card-buttons .rate-btn:hover {
  background-color: #FF857A;
  color: #ffffff;
}

/* Trash Button: Uses dark tone #6B403C */
.card-buttons .trash-btn {
  border-color: #6B403C;
  color: #6B403C;
}
.card-buttons .trash-btn:hover {
  background-color: #6B403C;
  color: #ffffff;
}

      /* PROFILE */
      .profile-card {
        position: relative;
        border: 1px solid #e1e4e8;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        margin-top: 20px;
        background: var(--card-bg);
      }
      .edit-icon {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: var(--primary-color);
        cursor: pointer;
        position: absolute;
        top: 10px;
        right: 10px;
      }
      .edit-icon:hover { color: var(--primary-hover); }
      .profile-card .profile-img {
        width: 100px;
        height: 100px;
        margin: 0 auto 10px;
        border-radius: 50%;
        overflow: hidden;
        background-color: #ddd;
      }
      .profile-card .profile-img img { width: 100%; height: 100%; object-fit: cover; }
      .profile-card .profile-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; }
      .profile-card .profile-stats { font-size: 0.9rem; color: #555; margin-top: 10px; }
      /* DETAILS PAGE COMPONENT */
      #detailsApp {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background: var(--card-bg);
        z-index: 200;
        padding: 20px;
        display: none;
      }
      .details-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
        position: relative;
      }
      /* Header Section */
      .details-header {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
      }
      .details-poster-container { flex-shrink: 0; }
      .details-poster {
        width: 180px;
        height: 270px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .details-header-info { flex: 1; }
      .details-header-info h1 {
        font-size: 1.8rem;
        margin: 0;
      }
      .detail-year, .detail-director {
        font-size: 1rem;
        margin: 5px 0;
        color: #555;
      }
      /* DETAILS ACTIONS */
      #detailsActions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      #detailsActions > button { flex: 1; }
      .btn-add-watchlist {
        background-color: var(--primary-color);
        color: var(--secondary-color);
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn-add-watchlist:disabled { background-color: #aaa; cursor: not-allowed; }
      .btn-add-watchlist:hover:not(:disabled) { background-color: var(--primary-hover); }
      /* Watch Trailer button – outlined style */
      #watchTrailerBtn {
        border: 1px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #watchTrailerBtn:hover { background-color: rgba(255,133,122,0.1); }
      /* Additional Info Section */
      .additional-info-section {
        margin-bottom: 20px;
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 8px;
      }
      .additional-info-section p { margin: 5px 0; font-size: 0.95rem; }
      /* TV Series Info Section */
      .tv-series-info-section { margin-bottom: 20px; }
      .tv-series-info-section label { margin-bottom: 5px; display: block; }
      /* Description Section */
      .details-description-section { margin-bottom: 20px; }
      .details-description-section h3 { margin-bottom: 10px; }
      .detail-overview {
        font-size: 1rem;
        line-height: 1.5;
        color: #444;
      }
      /* Cast Section */
      .details-cast { margin: 0 20px 15px 20px; }
      .details-cast h3 { margin-bottom: 0.5rem; font-size: 1.2rem; }
      .details-cast-list {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      .cast-item {
        text-align: center;
        flex: 0 0 auto;
        font-size: 0.9rem;
        width: 70px;
      }
      .cast-item img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin-bottom: 5px;
      }
      /* EMPTY STATE */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        font-size: 1.1rem;
        color: #777;
      }
      .empty-state img {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        margin-bottom: 20px;
      }
      /* NAVIGATION */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0 auto;
        width: 100%;
        max-width: 1200px;
        height: 60px;
        background-color: var(--card-bg);
        border-top: 1px solid #e1e4e8;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        z-index: 300;
      }
      .nav-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--secondary-color);
        cursor: pointer;
        transition: color 0.3s;
      }
      .nav-btn.active { color: var(--primary-color); }
      /* LOADING SPINNER */
      .spinner {
        text-align: center;
        padding: 20px;
      }
      /* MESSAGE CONTAINER */
      #messageContainer {
        position: fixed;
        top: 80px;
        width: 100%;
        text-align: center;
        z-index: 500;
      }
      /* MODAL STYLES */
      .modal-header, .modal-footer {
        background-color: #ffffff;
        color: var(--text-color);
      }
      .modal-content { border: 2px solid var(--accent-color); }
      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
      }
      /* STAR RATING ANIMATION */
      @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
      }
      #starRating .star {
        transition: transform 0.2s;
        cursor: pointer;
      }
      #starRating .star.clicked {
        animation: pop 0.3s;
      }
    </style>
  </head>
  <body>
    <!-- Message Container -->
    <div id="messageContainer"></div>

    <!-- MAIN APP VIEW -->
    <div id="mainApp" class="app-container">
      <!-- HEADER -->
      <header class="app-header">
        <h2 id="currentTabTitle">Explore</h2>
        <div id="profileContainer" class="profile-container">
          <span id="profileName" class="d-none d-sm-inline">John Doe</span>
          <div id="profileImageContainer">
            <img id="profileImage" src="https://thumbs.dreamstime.com/b/default-profile-picture-avatar-photo-placeholder-vector-illustration-default-profile-picture-avatar-photo-placeholder-vector-189495158.jpg" alt="Profile" loading="lazy">
          </div>
        </div>
      </header>

      <!-- CONTENT TABS -->
      <main class="app-content">
        <!-- WATCHLIST TAB -->
        <div id="watchlist" class="tab">
          <div id="watchlistControls" class="d-flex justify-content-between align-items-center mb-3">
            <div class="search-group" style="width:70%;">
              <input type="text" id="watchlistSearch" class="form-control form-control-sm" placeholder="Search watchlist...">
            </div>
            <select id="watchlistSort" class="form-select form-select-sm" style="width:28%;">
              <option value="release_new">Release Date: Newest First</option>
              <option value="release_old">Release Date: Oldest First</option>
              <option value="recent">Recently Added</option>
            </select>
          </div>
          <div id="watchlistContainer"></div>
        </div>

        <!-- EXPLORE TAB -->
        <div id="search" class="tab active-tab">
          <!-- Search group: Search input & Filter select -->
          <div class="search-group">
            <input type="text" id="searchQuery" class="form-control" placeholder="Search movies or series...">
            <select id="searchMediaType" class="form-select">
              <option value="all">All</option>
              <option value="movie">Movies</option>
              <option value="tv">TV Series</option>
            </select>
          </div>

          <!-- Search Results -->
          <div id="searchResults"></div>

          <!-- Genre Capsules -->
          <div id="genreCapsules"></div>

          <!-- Popular Movies Section -->
          <section id="popularSection">
            <h3>Popular Movies</h3>
            <div id="popularList" class="grid-container"></div>
          </section>

          <!-- Top Rated Section -->
          <section id="topRatedSection" class="carousel-section">
            <h3>Top Rated</h3>
            <div class="carousel-wrapper">
              <button id="topRatedLeftArrow" class="carousel-arrow left"><i class="fas fa-chevron-left"></i></button>
              <div id="topRatedCarousel" class="carousel-container"></div>
              <button id="topRatedRightArrow" class="carousel-arrow right"><i class="fas fa-chevron-right"></i></button>
            </div>
          </section>

          <!-- Upcoming Section -->
          <section id="upcomingSection" class="carousel-section">
            <h3>Upcoming</h3>
            <div class="carousel-wrapper">
              <button id="upcomingLeftArrow" class="carousel-arrow left"><i class="fas fa-chevron-left"></i></button>
              <div id="upcomingCarousel" class="carousel-container"></div>
              <button id="upcomingRightArrow" class="carousel-arrow right"><i class="fas fa-chevron-right"></i></button>
            </div>
          </section>
        </div>

        <!-- WATCHED TAB -->
        <div id="watched" class="tab">
          <div id="watchedControls" class="d-flex justify-content-between align-items-center mb-3">
            <div class="search-group" style="width:70%;">
              <input type="text" id="watchedSearch" class="form-control form-control-sm" placeholder="Search watched...">
            </div>
            <select id="watchedSort" class="form-select form-select-sm" style="width:28%;">
              <option value="release_new">Release Date: Newest First</option>
              <option value="release_old">Release Date: Oldest First</option>
              <option value="recent">Recently Added</option>
            </select>
          </div>
          <div id="watchedContainer"></div>
        </div>

        <!-- PROFILE TAB -->
        <div id="profile" class="tab">
          <div class="profile-card">
            <button type="button" class="btn btn-link edit-icon" id="profileEditBtn" data-bs-toggle="modal" data-bs-target="#profileModal">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <div class="profile-img">
              <img id="profileCardImage" src="https://thumbs.dreamstime.com/b/default-profile-picture-avatar-photo-placeholder-vector-illustration-default-profile-picture-avatar-photo-placeholder-vector-189495158.jpg" alt="Profile" loading="lazy">
            </div>
            <h4 class="profile-name" id="profileCardName">John Doe</h4>
            <p class="profile-stats" id="profileStats">
              Watched: 0 | Watchlisted: 0 | Watch Hours: 0h | Satisfaction: 0
            </p>
          </div>
        </div>
      </main>

      <!-- EDIT PROFILE MODAL -->
      <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="profileModalLabel">Edit Profile</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editName" class="form-label">Name</label>
                <input type="text" id="editName" class="form-control" placeholder="Enter your name">
              </div>
              <div class="mb-3">
                <label for="editImage" class="form-label">Profile Image</label>
                <input type="file" id="editImage" class="form-control" accept="image/*">
              </div>
              <div class="mb-3">
                <img id="profilePreview" src="" alt="Preview" class="img-fluid rounded" style="max-width:100px; display:none;">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id="saveProfileBtn" class="btn btn-primary">Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RATING MODAL -->
      <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="ratingModalLabel">Rate Your Viewing Experience</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <p class="mb-3">Tell us how much you enjoyed this show/movie. Select a star rating.</p>
              <div id="starRating" style="font-size:2rem;">
                <i class="far fa-star star" data-value="1"></i>
                <i class="far fa-star star" data-value="2"></i>
                <i class="far fa-star star" data-value="3"></i>
                <i class="far fa-star star" data-value="4"></i>
                <i class="far fa-star star" data-value="5"></i>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="submitRatingBtn" class="btn btn-primary"><i class="fas fa-star"></i> Submit Rating</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DETAILS PAGE COMPONENT -->
    <div id="detailsApp">
      <div class="details-container">
        <div class="details-header">
          <div class="details-poster-container">
            <img id="detailPoster" class="details-poster" src="" alt="Poster" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450.png?text=No+Image';">
          </div>
          <div class="details-header-info">
            <h1 id="detailTitle" class="details-title"></h1>
            <p id="detailReleaseYear" class="detail-year"></p>
            <p id="detailDirector" class="detail-director"></p>
          </div>
        </div>
        <!-- DETAILS ACTIONS -->
        <div id="detailsActions" class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary" id="watchTrailerBtn" style="display:none;">Watch Trailer</button>
          <button class="btn-add-watchlist" id="addToWatchlistBtn">Add to Watchlist</button>
        </div>
        <div class="additional-info-section" id="additionalInfo"></div>
        <div class="tv-series-info-section" id="tvSeriesInfoSection" style="display:none;">
          <div class="mb-3">
            <label for="seasonDropdown"><strong>Select Season:</strong></label>
            <select id="seasonDropdown" class="form-select"></select>
          </div>
          <div class="mb-3">
            <label for="episodeDropdown"><strong>Select Episode:</strong></label>
            <select id="episodeDropdown" class="form-select" disabled></select>
          </div>
        </div>
        <div class="details-description-section">
          <h3>Description</h3>
          <p id="detailOverview" class="detail-overview"></p>
        </div>
        <div class="details-cast">
          <h3>Cast</h3>
          <div id="castList" class="details-cast-list"></div>
        </div>
      </div>
    </div>

    <!-- NAVIGATION COMPONENT -->
    <nav class="bottom-nav">
      <button type="button" class="nav-btn" data-tab="watchlist" title="Watchlist">
        <i class="fas fa-bookmark"></i>
      </button>
      <button type="button" class="nav-btn active" data-tab="search" title="Explore">
        <i class="fas fa-search"></i>
      </button>
      <button type="button" class="nav-btn" data-tab="watched" title="Watched">
        <i class="fas fa-eye"></i>
      </button>
      <button type="button" class="nav-btn" data-tab="profile" title="Profile">
        <i class="fas fa-user"></i>
      </button>
    </nav>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const TMDB_API_KEY = "fa6ceab60f185619e0854acce9f0fcfd";
      let currentDetail = null;
      let ratingTarget = null; // holds the media item to be rated
      let selectedRating = 0;

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("searchQuery").value = "";
      });
      initMainApp();

      const urlParams = new URLSearchParams(window.location.search);
      const mediaTypeParam = urlParams.get("media_type");
      const idParam = urlParams.get("id");
      if (mediaTypeParam && idParam) {
        document.getElementById("detailsApp").style.display = "block";
        loadDetails(mediaTypeParam, idParam);
      } else {
        document.getElementById("detailsApp").style.display = "none";
      }

      document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", function () {
          if (document.getElementById("detailsApp").style.display === "block") {
            document.getElementById("detailsApp").style.display = "none";
            history.pushState("", document.title, window.location.pathname);
          }
          document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
          document.getElementById(tab).classList.add("active-tab");
          document.getElementById("currentTabTitle").innerText = this.title;
          if (tab === "profile") renderProfile();
          if (tab === "watchlist") renderWatchlist();
          if (tab === "watched") renderWatched();
        });
      });

      function initMainApp() {
        function saveData(mediaList, activityLog, userProfile) {
          localStorage.setItem("mediaList", JSON.stringify(mediaList));
          localStorage.setItem("activityLog", JSON.stringify(activityLog));
          localStorage.setItem("userProfile", JSON.stringify(userProfile));
        }
        let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        let activityLog = JSON.parse(localStorage.getItem("activityLog")) || [];
        let userProfile = JSON.parse(localStorage.getItem("userProfile")) || {
          name: "John Doe",
          image: "https://thumbs.dreamstime.com/b/default-profile-picture-avatar-photo-placeholder-vector-illustration-default-profile-picture-avatar-photo-placeholder-vector-189495158.jpg"
        };

        window.renderProfile = function() {
          mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
          const watchedItems = mediaList.filter(m => m.watched);
          const watchlistItems = mediaList.filter(m => !m.watched);
          const watchedCount = watchedItems.length;
          const watchlistCount = watchlistItems.length;
          const totalWatchHours = watchedItems.reduce((total, item) => total + (parseFloat(item.duration) || 0), 0).toFixed(1);
          const totalRating = watchedItems.reduce((sum, item) => sum + (item.rating || 0), 0);
          const avgRating = watchedCount ? (totalRating / watchedCount).toFixed(1) : "0";
          document.getElementById("profileCardImage").src = userProfile.image;
          document.getElementById("profileCardName").innerText = userProfile.name;
          document.getElementById("profileStats").innerText =
            `Watched: ${watchedCount} | Watchlisted: ${watchlistCount} | Watch Hours: ${totalWatchHours}h | Satisfaction: ${avgRating}`;
        };

        function updateProfileHeader() {
          document.getElementById("profileName").innerText = userProfile.name;
          document.getElementById("profileImage").src = userProfile.image;
        }

        let profileModalEl = document.getElementById('profileModal');
        profileModalEl.addEventListener('show.bs.modal', function () {
          document.getElementById("editName").value = userProfile.name;
          document.getElementById("editImage").value = "";
          document.getElementById("profilePreview").style.display = "none";
        });
        document.getElementById("editImage").addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (evt) {
              document.getElementById("profilePreview").src = evt.target.result;
              document.getElementById("profilePreview").style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        });
        document.getElementById("saveProfileBtn").addEventListener("click", function () {
          const newName = document.getElementById("editName").value || "John Doe";
          userProfile.name = newName;
          const fileInput = document.getElementById("editImage");
          if (fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function (evt) {
              userProfile.image = evt.target.result;
              saveData(mediaList, activityLog, userProfile);
              updateProfileHeader();
              renderProfile();
              let modal = bootstrap.Modal.getInstance(profileModalEl);
              modal.hide();
            };
            reader.readAsDataURL(fileInput.files[0]);
          } else {
            saveData(mediaList, activityLog, userProfile);
            updateProfileHeader();
            renderProfile();
            let modal = bootstrap.Modal.getInstance(profileModalEl);
            modal.hide();
          }
        });

        // Explore search input behavior
        const searchInput = document.getElementById("searchQuery");
        searchInput.addEventListener("input", debounce(function () {
          const query = this.value.trim();
          if(query) {
            document.getElementById("genreCapsules").style.display = "none";
            document.getElementById("popularSection").style.display = "none";
            document.getElementById("topRatedSection").style.display = "none";
            document.getElementById("upcomingSection").style.display = "none";
            performSearch(query);
          } else {
            document.getElementById("searchResults").innerHTML = "";
            document.getElementById("popularSection").style.display = "block";
            document.getElementById("topRatedSection").style.display = "block";
            document.getElementById("upcomingSection").style.display = "block";
            document.getElementById("genreCapsules").style.display = "flex";
            loadPopular();
            loadTopRated();
            loadUpcoming();
          }
        }, 500));

        document.getElementById("searchMediaType").addEventListener("change", function(){
          const query = searchInput.value.trim();
          if(query) performSearch(query);
        });

        function performSearch(query) {
          const resultsContainer = document.getElementById("searchResults");
          resultsContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
          const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`;
          fetch(url)
            .then(response => {
              if (!response.ok) throw new Error("Network response was not ok");
              return response.json();
            })
            .then(data => {
              if (data.results && Array.isArray(data.results)) {
                const mediaTypeFilter = document.getElementById("searchMediaType").value;
                let results = data.results;
                if (mediaTypeFilter !== "all") {
                  results = results.filter(item => item.media_type === mediaTypeFilter);
                }
                renderSearchResults(results);
              } else {
                resultsContainer.innerHTML = `
                  <div class='empty-state'>
                    <img src='https://via.placeholder.com/400x300.png?text=No+Results' alt='No Results'><br>
                    No results found. Try another search!
                  </div>
                `;
              }
            })
            .catch(error => {
              console.error("Search error:", error);
              resultsContainer.innerHTML = `
                <div class='empty-state'>
                  <img src='https://via.placeholder.com/400x300.png?text=Error' alt='Error'><br>
                  Error fetching search results.
                </div>
              `;
            });
        }

        function renderSearchResults(results) {
          const container = document.getElementById("searchResults");
          container.innerHTML = "";
          results.forEach(item => {
            if (item.media_type !== "movie" && item.media_type !== "tv") return;
            const title = (item.media_type === "movie") ? item.title : item.name;
            const date = (item.media_type === "movie") ? item.release_date : item.first_air_date;
            const year = date ? date.substring(0, 4) : "N/A";
            const posterUrl = item.poster_path
              ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
              : "https://via.placeholder.com/200x300.png?text=No+Image";
            const card = document.createElement("div");
            card.className = "search-card";
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
              <div class="card-body">
                <h5 class="card-title">${title}</h5>
                <p class="card-text"><small>${year}</small></p>
              </div>
            `;
            // Allow the entire card to be clickable in the Explore page.
            card.addEventListener("click", function() {
              openDetailsPage(item.id, item.media_type);
            });
            container.appendChild(card);
          });
        }

        function openDetailsPage(id, mediaType) {
          history.pushState({}, "", `?media_type=${mediaType}&id=${id}`);
          document.getElementById("detailsApp").style.display = "block";
          loadDetails(mediaType, id);
        }

        // Render Watchlist cards with three top-right buttons (non-clickable card body)
        function renderWatchlist() {
          mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
          const container = document.getElementById("watchlistContainer");
          const controls = document.getElementById("watchlistControls");
          let list = mediaList.filter(m => !m.watched);
          const searchQuery = document.getElementById("watchlistSearch").value.toLowerCase();
          if (searchQuery) {
            list = list.filter(m => m.title.toLowerCase().includes(searchQuery));
          }
          if (list.length === 0) {
            controls.style.display = "none";
            container.innerHTML = `
              <div class='empty-state'>
                <img src='https://img.freepik.com/free-vector/open-air-cinema_23-2148644732.jpg?w=996' alt='Empty'><br>
                Your watchlist is empty. Add some media!
              </div>
            `;
            return;
          } else {
            controls.style.display = "flex";
          }
          const sortOrder = document.getElementById("watchlistSort").value || "release_new";
          list.sort((a, b) => {
            if (sortOrder === "release_new") {
              return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
            } else if (sortOrder === "release_old") {
              return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
            } else if (sortOrder === "recent") {
              return (b.added || 0) - (a.added || 0);
            }
          });
          container.innerHTML = "";
          list.forEach((m) => {
            const extraInfo = (m.media_type === "movie")
              ? `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`
              : "";
            const year = m.date ? m.date.substring(0, 4) : "N/A";
            const card = document.createElement("div");
            card.className = "card mb-2 media-card";
            card.style.position = "relative";
            card.innerHTML = `
              <div class="card-buttons">
                <button class="btn btn-sm btn-outline-primary view-btn" title="View"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-outline-success rate-btn" title="Rate"><i class="fas fa-star"></i></button>
                <button class="btn btn-sm btn-outline-danger trash-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
              </div>
              <div class="row g-0">
                <div class="col-auto">
                  <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:70px; height:105px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/70x105.png?text=No+Image';">
                </div>
                <div class="col">
                  <div class="card-body">
                    <h5 class="card-title">${m.title}</h5>
                    <p class="card-text"><small>${year}</small></p>
                    ${extraInfo}
                    <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  </div>
                </div>
              </div>
            `;
            // Button event listeners for watchlist
            card.querySelector(".view-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              openDetailsPage(m.id, m.media_type);
            });
            card.querySelector(".rate-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              ratingTarget = m;
              let modal = new bootstrap.Modal(document.getElementById("ratingModal"));
              modal.show();
            });
            card.querySelector(".trash-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              if(confirm("Are you sure you want to delete this item?")) {
                let updatedList = JSON.parse(localStorage.getItem("mediaList")) || [];
                updatedList = updatedList.filter(item => !(item.id === m.id && item.media_type === m.media_type));
                localStorage.setItem("mediaList", JSON.stringify(updatedList));
                renderWatchlist();
              }
            });
            container.appendChild(card);
          });
        }
        window.renderWatchlist = renderWatchlist;

        // Render Watched cards with three top-right buttons (non-clickable card body)
        function renderWatched() {
          mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
          const container = document.getElementById("watchedContainer");
          const controls = document.getElementById("watchedControls");
          let list = mediaList.filter(m => m.watched);
          const searchQuery = document.getElementById("watchedSearch").value.toLowerCase();
          if (searchQuery) {
            list = list.filter(m => m.title.toLowerCase().includes(searchQuery));
          }
          if (list.length === 0) {
            controls.style.display = "none";
            container.innerHTML = `
              <div class='empty-state'>
                <img src='https://img.freepik.com/free-vector/hand-drawn-movie-theater-drawing-illustration_23-2151023043.jpg?w=740' alt='Empty'><br>
                No watched items yet. Time for a movie marathon!
              </div>
            `;
            return;
          } else {
            controls.style.display = "flex";
          }
          const sortOrder = document.getElementById("watchedSort").value || "release_new";
          list.sort((a, b) => {
            if (sortOrder === "release_new") {
              return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
            } else if (sortOrder === "release_old") {
              return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
            } else if (sortOrder === "recent") {
              return (b.added || 0) - (a.added || 0);
            }
          });
          container.innerHTML = "";
          list.forEach((m) => {
            const extraInfo = (m.media_type === "movie")
              ? `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`
              : "";
            const year = m.date ? m.date.substring(0, 4) : "N/A";
            const card = document.createElement("div");
            card.className = "card mb-2 media-card";
            card.style.position = "relative";
            card.innerHTML = `
              <div class="card-buttons">
                <button class="btn btn-sm btn-outline-primary view-btn" title="View"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-outline-success rate-btn" title="Rate"><i class="fas fa-star"></i></button>
                <button class="btn btn-sm btn-outline-danger trash-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
              </div>
              <div class="row g-0">
                <div class="col-auto">
                  <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:70px; height:105px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/70x105.png?text=No+Image';">
                </div>
                <div class="col">
                  <div class="card-body">
                    <h5 class="card-title">${m.title}</h5>
                    <p class="card-text"><small>${year}</small></p>
                    ${extraInfo}
                    <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                    <p class="card-text"><small>Rating: ${m.rating ? m.rating + " / 5" : "Not rated"}</small></p>
                  </div>
                </div>
              </div>
            `;
            // Button event listeners for watched list
            card.querySelector(".view-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              openDetailsPage(m.id, m.media_type);
            });
            card.querySelector(".rate-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              ratingTarget = m;
              let modal = new bootstrap.Modal(document.getElementById("ratingModal"));
              modal.show();
            });
            card.querySelector(".trash-btn").addEventListener("click", function (e) {
              e.stopPropagation();
              if(confirm("Are you sure you want to delete this item?")) {
                let updatedList = JSON.parse(localStorage.getItem("mediaList")) || [];
                updatedList = updatedList.filter(item => !(item.id === m.id && item.media_type === m.media_type));
                localStorage.setItem("mediaList", JSON.stringify(updatedList));
                renderWatched();
              }
            });
            container.appendChild(card);
          });
        }
        window.renderWatched = renderWatched;

        function debounce(func, delay) {
          let timer;
          return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
          };
        }
        document.getElementById("watchlistSort").addEventListener("change", renderWatchlist);
        document.getElementById("watchedSort").addEventListener("change", renderWatched);
        renderWatchlist();
        renderWatched();
        updateProfileHeader();

        // Load sections for Explore tab
        loadPopular();
        loadTopRated();
        loadUpcoming();
        loadGenres();
      }

      async function loadPopular() {
        const container = document.getElementById("popularList");
        container.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading Popular Movies...</div>';
        const url = `https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_API_KEY}&language=en-US&page=1`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          container.innerHTML = "";
          const items = data.results.slice(0, 50);
          items.forEach(item => {
            const title = item.title;
            const date = item.release_date || "";
            const year = date ? date.substring(0, 4) : "N/A";
            const posterUrl = item.poster_path
              ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
              : "https://via.placeholder.com/200x300.png?text=No+Image";
            const card = document.createElement("div");
            card.className = "search-card";
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
              <div class="card-body">
                <h5 class="card-title">${title}</h5>
                <p class="card-text"><small>${year}</small></p>
              </div>
            `;
            card.addEventListener("click", function () {
              openDetailsPage(item.id, "movie");
            });
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading popular movies:", error);
          container.innerHTML = `<div class='empty-state'>Error loading popular movies.</div>`;
        }
      }

      async function loadTopRated() {
        const container = document.getElementById("topRatedCarousel");
        container.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading Top Rated...</div>';
        const url = `https://api.themoviedb.org/3/movie/top_rated?api_key=${TMDB_API_KEY}&language=en-US&page=1`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          container.innerHTML = "";
          const items = data.results.slice(0, 15);
          items.forEach(item => {
            const title = item.title;
            const date = item.release_date || "";
            const year = date ? date.substring(0, 4) : "N/A";
            const posterUrl = item.poster_path
              ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
              : "https://via.placeholder.com/200x300.png?text=No+Image";
            const card = document.createElement("div");
            card.className = "search-card";
            card.style.minWidth = "140px";
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
              <div class="card-body">
                <h5 class="card-title" style="font-size:0.9rem;">${title}</h5>
                <p class="card-text"><small>${year}</small></p>
              </div>
            `;
            card.addEventListener("click", function () {
              openDetailsPage(item.id, "movie");
            });
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading top rated movies:", error);
          container.innerHTML = `<div class='empty-state'>Error loading top rated movies.</div>`;
        }
        document.getElementById("topRatedLeftArrow").addEventListener("click", function() {
          container.scrollBy({ left: -300, behavior: "smooth" });
        });
        document.getElementById("topRatedRightArrow").addEventListener("click", function() {
          container.scrollBy({ left: 300, behavior: "smooth" });
        });
      }

      async function loadUpcoming() {
        const container = document.getElementById("upcomingCarousel");
        container.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading Upcoming...</div>';
        const url = `https://api.themoviedb.org/3/movie/upcoming?api_key=${TMDB_API_KEY}&language=en-US&page=1`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          container.innerHTML = "";
          const items = data.results.slice(0, 15);
          items.forEach(item => {
            const title = item.title;
            const date = item.release_date || "";
            const year = date ? date.substring(0, 4) : "N/A";
            const posterUrl = item.poster_path
              ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
              : "https://via.placeholder.com/200x300.png?text=No+Image";
            const card = document.createElement("div");
            card.className = "search-card";
            card.style.minWidth = "140px";
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
              <div class="card-body">
                <h5 class="card-title" style="font-size:0.9rem;">${title}</h5>
                <p class="card-text"><small>${year}</small></p>
              </div>
            `;
            card.addEventListener("click", function () {
              openDetailsPage(item.id, "movie");
            });
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading upcoming movies:", error);
          container.innerHTML = `<div class='empty-state'>Error loading upcoming movies.</div>`;
        }
        document.getElementById("upcomingLeftArrow").addEventListener("click", function() {
          container.scrollBy({ left: -300, behavior: "smooth" });
        });
        document.getElementById("upcomingRightArrow").addEventListener("click", function() {
          container.scrollBy({ left: 300, behavior: "smooth" });
        });
      }

      function loadGenres() {
        const container = document.getElementById("genreCapsules");
        const url = `https://api.themoviedb.org/3/genre/movie/list?api_key=${TMDB_API_KEY}&language=en-US`;
        fetch(url)
          .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then(data => {
            container.innerHTML = "";
            const allCapsule = document.createElement("span");
            allCapsule.className = "badge genre-capsule selected";
            allCapsule.style.marginRight = "5px";
            allCapsule.innerText = "All";
            allCapsule.addEventListener("click", function() {
              document.querySelectorAll("#genreCapsules .genre-capsule").forEach(b => b.classList.remove("selected"));
              this.classList.add("selected");
              loadPopular();
            });
            container.appendChild(allCapsule);
            data.genres.forEach(genre => {
              const capsule = document.createElement("span");
              capsule.className = "badge genre-capsule";
              capsule.style.marginRight = "5px";
              capsule.innerText = genre.name;
              capsule.dataset.genreId = genre.id;
              capsule.addEventListener("click", function() {
                document.querySelectorAll("#genreCapsules .genre-capsule").forEach(b => b.classList.remove("selected"));
                this.classList.add("selected");
                loadPopularByGenre(this.dataset.genreId);
              });
              container.appendChild(capsule);
            });
          })
          .catch(error => {
            console.error("Error loading genres:", error);
            container.innerHTML = "Error loading genres.";
          });
      }

      async function loadPopularByGenre(genreId) {
        const container = document.getElementById("popularList");
        container.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        const url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_API_KEY}&with_genres=${genreId}&language=en-US&page=1`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          container.innerHTML = "";
          const items = data.results.slice(0, 50);
          items.forEach(item => {
            const title = item.title;
            const date = item.release_date || "";
            const year = date ? date.substring(0, 4) : "N/A";
            const posterUrl = item.poster_path
              ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
              : "https://via.placeholder.com/200x300.png?text=No+Image";
            const card = document.createElement("div");
            card.className = "search-card";
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
              <div class="card-body">
                <h5 class="card-title">${title}</h5>
                <p class="card-text"><small>${year}</small></p>
              </div>
            `;
            card.addEventListener("click", function () {
              openDetailsPage(item.id, "movie");
            });
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading movies by genre:", error);
          container.innerHTML = `<div class='empty-state'>Error loading movies by genre.</div>`;
        }
      }

      function loadDetails(mediaType, id) {
        if (!mediaType || !id) {
          document.getElementById("detailTitle").innerText = "Invalid Item";
          return;
        }
        const apiUrl = (mediaType === "movie")
          ? `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits,seasons`
          : `https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits,seasons`;
        fetch(apiUrl)
          .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then(details => {
            renderDetails(details, mediaType);
            fetchTrailer(mediaType, id);
          })
          .catch(error => {
            console.error("Error fetching details:", error);
            document.getElementById("detailTitle").innerText = "Error Loading Details";
          });
      }

      function renderDetails(details, mediaType) {
        const title = (mediaType === "movie") ? details.title : details.name;
        document.getElementById("detailTitle").innerText = title;
        const releaseYear = (details.release_date || details.first_air_date || "").substring(0,4) || "N/A";
        document.getElementById("detailReleaseYear").innerText = releaseYear;
        let director = "N/A";
        if (details.credits && details.credits.crew) {
          const directorObj = details.credits.crew.find(member => member.job === "Director")
                          || details.credits.crew.find(member => member.job === "Executive Producer");
          if (directorObj) director = directorObj.name;
        }
        document.getElementById("detailDirector").innerText = "Director: " + director;
        let infoHtml = "";
        if (details.genres && details.genres.length > 0) {
          infoHtml += `<p><strong>Genres:</strong> ${details.genres.map(g => g.name).join(', ')}</p>`;
        }
        if (mediaType === "movie") {
          const runtimeHours = details.runtime ? (details.runtime / 60).toFixed(1) + "h" : "N/A";
          infoHtml += `<p><strong>Duration:</strong> ${runtimeHours}</p>`;
        } else if (mediaType === "tv") {
          infoHtml += `<p><strong>Episode Runtime:</strong> ${
            details.episode_run_time && details.episode_run_time.length > 0
              ? details.episode_run_time[0] + " min"
              : "N/A"
          }</p>`;
        }
        infoHtml += `<p><strong>Language:</strong> ${details.original_language || "N/A"}</p>`;
        infoHtml += `<p><strong>TMDB Rating:</strong> ${
          details.vote_average ? details.vote_average.toFixed(1) + " / 10" : "N/A"
        }</p>`;
        document.getElementById("additionalInfo").innerHTML = infoHtml;
        if (mediaType === "tv" && details.seasons && details.seasons.length > 0) {
          document.getElementById("tvSeriesInfoSection").style.display = "block";
          const seasonDropdown = document.getElementById("seasonDropdown");
          seasonDropdown.innerHTML = "";
          details.seasons.forEach(season => {
            const option = document.createElement("option");
            option.value = season.season_number;
            option.text = season.name + (season.episode_count ? ` (${season.episode_count} episodes)` : "");
            seasonDropdown.appendChild(option);
          });
          loadEpisodes(details.id, details.seasons[0].season_number);
          seasonDropdown.addEventListener("change", function() {
            loadEpisodes(details.id, this.value);
          });
        } else {
          document.getElementById("tvSeriesInfoSection").style.display = "none";
        }
        document.getElementById("detailOverview").innerText = details.overview || "No description available.";
        // Load cast information (up to 10 cast members)
        if(details.credits && details.credits.cast && details.credits.cast.length > 0) {
          const castListEl = document.getElementById("castList");
          castListEl.innerHTML = "";
          details.credits.cast.slice(0, 10).forEach(castMember => {
             const castItem = document.createElement("div");
             castItem.className = "cast-item";
             const profileImg = castMember.profile_path 
                 ? `https://image.tmdb.org/t/p/w200${castMember.profile_path}` 
                 : "https://via.placeholder.com/60x60.png?text=No+Image";
             castItem.innerHTML = `<img src="${profileImg}" alt="${castMember.name}" onerror="this.src='https://via.placeholder.com/60x60.png?text=No+Image';"><br>${castMember.name}`;
             castListEl.appendChild(castItem);
          });
        } else {
          document.getElementById("castList").innerHTML = "<p>No cast information available.</p>";
        }
        const posterUrl = details.poster_path
          ? `https://image.tmdb.org/t/p/w300${details.poster_path}`
          : "https://via.placeholder.com/300x450.png?text=No+Image";
        document.getElementById("detailPoster").src = posterUrl;
        currentDetail = {
          id: details.id,
          media_type: mediaType,
          title: title,
          date: details.release_date || details.first_air_date || "",
          poster: posterUrl,
          rating: null,
          overview: details.overview || "",
          added: Date.now()
        };
        if(mediaType === "movie") {
          currentDetail.duration = details.runtime ? (details.runtime / 60).toFixed(1) : "N/A";
        }
        let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        if(mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type)){
          document.getElementById("addToWatchlistBtn").innerText = "Already in Watchlist";
          document.getElementById("addToWatchlistBtn").disabled = true;
        } else {
          document.getElementById("addToWatchlistBtn").innerText = "Add to Watchlist";
          document.getElementById("addToWatchlistBtn").disabled = false;
        }
      }

      function loadEpisodes(tvId, seasonNumber) {
        const seasonUrl = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${TMDB_API_KEY}`;
        fetch(seasonUrl)
          .then(response => response.json())
          .then(data => {
            const episodeDropdown = document.getElementById("episodeDropdown");
            episodeDropdown.innerHTML = "";
            if (data.episodes && data.episodes.length > 0) {
              episodeDropdown.disabled = false;
              data.episodes.forEach(episode => {
                const option = document.createElement("option");
                option.value = episode.episode_number;
                option.text = `Ep ${episode.episode_number}: ${episode.name}`;
                episodeDropdown.appendChild(option);
              });
            } else {
              episodeDropdown.innerHTML = "<option>No episodes found</option>";
              episodeDropdown.disabled = true;
            }
          })
          .catch(error => {
            console.error("Error fetching episodes:", error);
            const episodeDropdown = document.getElementById("episodeDropdown");
            episodeDropdown.innerHTML = "<option>Error loading episodes</option>";
            episodeDropdown.disabled = true;
          });
      }

      document.getElementById("addToWatchlistBtn").addEventListener("click", function() {
        if (!currentDetail) return;
        let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        const found = mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type);
        if (!found) {
          mediaList.push(currentDetail);
          localStorage.setItem("mediaList", JSON.stringify(mediaList));
          this.innerText = "Added to Watchlist";
          this.disabled = true;
        }
      });

      async function fetchTrailer(mediaType, id) {
        let url;
        if (mediaType === "movie") {
          url = `https://api.themoviedb.org/3/movie/${id}/videos?api_key=${TMDB_API_KEY}`;
        } else {
          url = `https://api.themoviedb.org/3/tv/${id}/videos?api_key=${TMDB_API_KEY}`;
        }
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          const trailers = data.results.filter(video => video.type === "Trailer" && video.site === "YouTube");
          if (trailers.length > 0) {
            const trailerUrl = `https://www.youtube.com/watch?v=${trailers[0].key}`;
            const btn = document.getElementById("watchTrailerBtn");
            btn.style.display = "block";
            btn.onclick = () => window.open(trailerUrl, "_blank");
          } else {
            document.getElementById("watchTrailerBtn").style.display = "none";
          }
        } catch (error) {
          console.error("Error fetching trailer:", error);
          document.getElementById("watchTrailerBtn").style.display = "none";
        }
      }

      // Star rating with animation
      document.querySelectorAll("#starRating .star").forEach(star => {
        star.addEventListener("click", function(){
          selectedRating = parseInt(this.getAttribute("data-value"));
          document.querySelectorAll("#starRating .star").forEach(s => {
            if (parseInt(s.getAttribute("data-value")) <= selectedRating) {
              s.classList.remove("far");
              s.classList.add("fas", "clicked");
              setTimeout(() => s.classList.remove("clicked"), 300);
            } else {
              s.classList.remove("fas");
              s.classList.add("far");
            }
          });
        });
      });

      document.getElementById("submitRatingBtn").addEventListener("click", function(){
          if(selectedRating === 0){
              alert("Please select a rating first.");
              return;
          }
          if(ratingTarget){
              ratingTarget.watched = true;
              ratingTarget.rating = selectedRating;
              let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
              mediaList = mediaList.map(item => (item.id === ratingTarget.id && item.media_type === ratingTarget.media_type) ? ratingTarget : item);
              localStorage.setItem("mediaList", JSON.stringify(mediaList));
              renderWatchlist();
              renderWatched();
              let modal = bootstrap.Modal.getInstance(document.getElementById("ratingModal"));
              modal.hide();
              selectedRating = 0;
              document.querySelectorAll("#starRating .star").forEach(s => {
                s.classList.remove("fas");
                s.classList.add("far");
              });
          }
      });
    </script>
  </body>
</html>
