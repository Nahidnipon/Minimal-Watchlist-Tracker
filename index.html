<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Media Watchlist</title>

  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary-color: #1abc9c;
      --primary-hover: #17a589;
      --secondary-color: #333;
      --bg-color: #f0f2f5;
      --card-bg: #fff;
      --text-color: #333;
    }
    /* Base reset and font */
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      min-height: 100vh;
    }
    /* Main container adjusted for wider screens */
    .app-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      position: relative;
    }
    /* HEADER */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #e1e4e8;
      margin-bottom: 10px;
    }
    #currentTabTitle {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .profile-container {
      display: inline-flex;
      align-items: center;
    }
    #profileName {
      margin-right: 10px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    #profileImageContainer {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background-color: #ddd;
    }
    #profileImageContainer img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* CONTENT TABS */
    .app-content {
      /* extra bottom padding so content isn't hidden behind fixed nav */
      padding: 10px 0 80px;
    }
    .tab {
      display: none;
    }
    .tab.active-tab {
      display: block;
    }
    /* SEARCH COMPONENT */
    .search-group {
      margin-bottom: 1rem;
    }
    #searchResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .search-card {
      border: none;
      border-radius: 8px;
      overflow: hidden;
      background: var(--card-bg);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .search-card:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-card img {
      width: 100%;
      height: auto;
      display: block;
    }
    .search-card .card-body {
      padding: 0.5rem;
    }
    .search-card .card-title {
      font-size: 1rem;
      margin: 0;
      font-weight: 500;
    }
    .search-card .card-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.25rem;
    }
    /* WATCHLIST / WATCHED CARDS */
    .media-card {
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      background: var(--card-bg);
      padding: 10px;
      position: relative;
    }
    .media-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .media-card img {
      width: 80px;
      height: 120px;
      object-fit: cover;
      margin-right: 10px;
    }
    .media-card .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 1rem;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    .media-card .delete-btn:hover {
      opacity: 1;
    }
    /* PROFILE */
    .profile-card {
      position: relative;
      border: 1px solid #e1e4e8;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin-top: 20px;
      background: var(--card-bg);
    }
    .edit-icon {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--primary-color);
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .profile-card .profile-img {
      width: 100px;
      height: 100px;
      margin: 0 auto 10px;
      border-radius: 50%;
      overflow: hidden;
      background-color: #ddd;
    }
    .profile-card .profile-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-card .profile-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .profile-card .profile-stats {
      font-size: 0.9rem;
      color: #555;
      margin-top: 10px;
    }
    /* ------------------ DETAILS PAGE COMPONENT ------------------ */
    #detailsApp {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background: var(--card-bg);
      z-index: 200;
      padding: 20px;
      display: none;
    }
    .details-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 20px;
      position: relative;
    }
    /* Header Section: Poster & Basic Info */
    .details-header {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }
    .details-poster-container {
      flex-shrink: 0;
    }
    .details-poster {
      width: 120px;
      height: 180px;
      object-fit: cover;
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .details-header-info {
      flex: 1;
    }
    .details-header-info h1 {
      font-size: 1.8rem;
      margin: 0;
    }
    .detail-year,
    .detail-director {
      font-size: 1rem;
      margin: 5px 0;
      color: #555;
    }
    /* Watchlist/Rating Section */
    #detailsActions {
      text-align: center;
      margin-bottom: 20px;
    }
    .btn-add-watchlist {
      background-color: var(--primary-color);
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      width: 80%;
      max-width: 300px;
      margin: 20px auto;
      transition: background-color 0.3s;
    }
    .btn-add-watchlist:hover {
      background-color: var(--primary-hover);
    }
    .details-rating-section {
      padding: 10px 20px;
      text-align: center;
      width: 80%;
      max-width: 300px;
      margin: 20px auto;
    }
    .details-rating-section h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .details-rating-section i.fas.fa-star {
      font-size: 1.6rem;
      margin: 0 5px;
      color: #ccc;
      cursor: pointer;
    }
    .details-rating-section i.fas.fa-star.selected {
      color: gold;
    }
    .details-rating-section button {
      background-color: var(--primary-color);
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .details-rating-section button:hover {
      background-color: var(--primary-hover);
    }
    #detailsUserRating h3 {
      font-size: 1.2rem;
      font-weight: 500;
    }
    /* Additional Info Section */
    .additional-info-section {
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 8px;
    }
    .additional-info-section p {
      margin: 5px 0;
      font-size: 0.95rem;
    }
    /* TV Series Info: Season & Episode Dropdowns */
    .tv-series-info-section {
      margin-bottom: 20px;
    }
    .tv-series-info-section label {
      margin-bottom: 5px;
      display: block;
    }
    /* Description Section */
    .details-description-section {
      margin-bottom: 20px;
    }
    .detail-overview {
      font-size: 1rem;
      line-height: 1.5;
      color: #444;
    }
    /* Cast Section */
    .details-cast {
      margin: 0 20px 15px 20px;
    }
    .details-cast h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .details-cast-list {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .cast-item {
      text-align: center;
      flex: 0 0 auto;
      font-size: 0.9rem;
      width: 70px;
    }
    .cast-item img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      margin-bottom: 5px;
    }
    /* ------------------ EMPTY STATE STYLES ------------------ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      font-size: 1.1rem;
      color: #777;
    }
    .empty-state img {
      max-width: 400px;
      margin-bottom: 20px;
    }
    /* ------------------ NAVIGATION COMPONENT ------------------ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 100%;
      max-width: 1200px;
      height: 60px;
      background-color: var(--card-bg);
      border-top: 1px solid #e1e4e8;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 300;
    }
    .nav-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--secondary-color);
      cursor: pointer;
      transition: color 0.3s;
    }
    .nav-btn.active {
      color: var(--primary-color);
    }
    /* LOADING SPINNER */
    .spinner {
      text-align: center;
      padding: 20px;
    }
    /* MESSAGE CONTAINER (unused) */
    #messageContainer {
      position: fixed;
      top: 80px;
      width: 100%;
      text-align: center;
      z-index: 500;
    }
  </style>
</head>
<body>
  <!-- Message Container -->
  <div id="messageContainer"></div>

  <!-- MAIN APP VIEW -->
  <div id="mainApp" class="app-container">
    <!-- HEADER COMPONENT -->
    <header class="app-header">
      <h2 id="currentTabTitle">Search</h2>
      <div id="profileContainer" class="profile-container">
        <span id="profileName" class="d-none d-sm-inline">Default Name</span>
        <div id="profileImageContainer">
          <img id="profileImage" src="https://via.placeholder.com/40" alt="Profile" loading="lazy">
        </div>
      </div>
    </header>

    <!-- CONTENT TABS -->
    <main class="app-content">
      <!-- WATCHLIST TAB -->
      <div id="watchlist" class="tab">
        <div id="watchlistFilters" class="d-flex justify-content-end mb-3">
          <select id="watchlistSort" class="form-select form-select-sm" style="width: auto;">
            <option value="release_new">Release Date: Newest First</option>
            <option value="release_old">Release Date: Oldest First</option>
            <option value="recent">Recently Added</option>
          </select>
        </div>
        <div id="watchlistContainer"></div>
      </div>
      <!-- SEARCH TAB -->
      <div id="search" class="tab active-tab">
        <div class="search-group input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" id="searchQuery" class="form-control" placeholder="Search movies or series...">
        </div>
        <div id="searchResults"></div>
      </div>
      <!-- WATCHED TAB -->
      <div id="watched" class="tab">
        <div id="watchedFilters" class="d-flex justify-content-end mb-3">
          <select id="watchedSort" class="form-select form-select-sm" style="width: auto;">
            <option value="release_new">Release Date: Newest First</option>
            <option value="release_old">Release Date: Oldest First</option>
            <option value="recent">Recently Added</option>
          </select>
        </div>
        <div id="watchedContainer"></div>
      </div>
      <!-- PROFILE TAB -->
      <div id="profile" class="tab">
        <div class="profile-card">
          <button type="button" class="btn btn-link edit-icon" id="profileEditBtn" data-bs-toggle="modal" data-bs-target="#profileModal">
            <i class="fas fa-pencil-alt"></i>
          </button>
          <div class="profile-img">
            <img id="profileCardImage" src="https://via.placeholder.com/100" alt="Profile" loading="lazy">
          </div>
          <h4 class="profile-name" id="profileCardName">Default Name</h4>
          <p class="profile-stats" id="profileStats">
            Watched: 0 | Watchlisted: 0 | Watch Hours: 0h | Satisfaction: 0
          </p>
        </div>
      </div>
    </main>

    <!-- EDIT PROFILE MODAL -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" id="editName" class="form-control" placeholder="Enter your name">
            </div>
            <div class="mb-3">
              <label for="editImage" class="form-label">Profile Image</label>
              <input type="file" id="editImage" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
              <img id="profilePreview" src="" alt="Preview" class="img-fluid rounded" style="max-width:100px; display:none;">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="saveProfileBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS PAGE COMPONENT (Banner Removed) -->
  <div id="detailsApp">
    <div class="details-container">
      <!-- Header: Poster & Basic Info -->
      <div class="details-header">
        <div class="details-poster-container">
          <img id="detailPoster" class="details-poster" src="" alt="Poster" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450.png?text=No+Image';">
        </div>
        <div class="details-header-info">
          <h1 id="detailTitle" class="details-title"></h1>
          <p id="detailReleaseYear" class="detail-year"></p>
          <p id="detailDirector" class="detail-director"></p>
        </div>
      </div>
      <!-- Add to Watchlist / Rating Section -->
      <div id="detailsActions" class="text-center">
        <button class="btn-add-watchlist" id="addToWatchlistBtn">
          <i class="fas fa-plus"></i> Add to Watchlist
        </button>
        <div class="details-rating-section" id="detailsRatingSection" style="display: none;">
          <h3>Share your experience!</h3>
          <div id="starRatingDetails" class="d-flex justify-content-center">
            <i class="fas fa-star" data-value="1" style="cursor:pointer;"></i>
            <i class="fas fa-star" data-value="2" style="cursor:pointer;"></i>
            <i class="fas fa-star" data-value="3" style="cursor:pointer;"></i>
            <i class="fas fa-star" data-value="4" style="cursor:pointer;"></i>
            <i class="fas fa-star" data-value="5" style="cursor:pointer;"></i>
          </div>
          <button id="submitRatingBtn">Submit</button>
        </div>
        <div id="detailsUserRating" class="text-center" style="display:none;">
          <h3>Your rating: <span id="userRatingValue"></span> / 5</h3>
        </div>
      </div>
      <!-- Additional Info Section -->
      <div class="additional-info-section" id="additionalInfo">
        <!-- Additional info will be inserted here -->
      </div>
      <!-- TV Series Info Section (for TV shows only) -->
      <div class="tv-series-info-section" id="tvSeriesInfoSection" style="display:none;">
         <div class="mb-3">
             <label for="seasonDropdown"><strong>Select Season:</strong></label>
             <select id="seasonDropdown" class="form-select"></select>
         </div>
         <div class="mb-3">
             <label for="episodeDropdown"><strong>Select Episode:</strong></label>
             <select id="episodeDropdown" class="form-select" disabled></select>
         </div>
      </div>
      <!-- Description Section -->
      <div class="details-description-section">
        <p id="detailOverview" class="detail-overview"></p>
      </div>
      <!-- Cast Section -->
      <div class="details-cast">
        <h3>Cast</h3>
        <div id="castList" class="details-cast-list"></div>
      </div>
    </div>
  </div>

  <!-- NAVIGATION COMPONENT -->
  <nav class="bottom-nav">
    <button type="button" class="nav-btn" data-tab="watchlist" title="Watchlist">
      <i class="fas fa-bookmark"></i>
    </button>
    <button type="button" class="nav-btn active" data-tab="search" title="Search">
      <i class="fas fa-search"></i>
    </button>
    <button type="button" class="nav-btn" data-tab="watched" title="Watched">
      <i class="fas fa-eye"></i>
    </button>
    <button type="button" class="nav-btn" data-tab="profile" title="Profile">
      <i class="fas fa-user"></i>
    </button>
  </nav>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const TMDB_API_KEY = "fa6ceab60f185619e0854acce9f0fcfd";
    let currentDetail = null;
    let selectedRating = 0; // For interactive rating

    const urlParams = new URLSearchParams(window.location.search);
    const mediaTypeParam = urlParams.get("media_type");
    const idParam = urlParams.get("id");

    // Initialize main app
    initMainApp();
    if (mediaTypeParam && idParam) {
      document.getElementById("detailsApp").style.display = "block";
      loadDetails(mediaTypeParam, idParam);
    } else {
      document.getElementById("detailsApp").style.display = "none";
    }

    // Global Navigation Tabs
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        if (document.getElementById("detailsApp").style.display === "block") {
          document.getElementById("detailsApp").style.display = "none";
          history.pushState("", document.title, window.location.pathname);
        }
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        const tab = this.getAttribute("data-tab");
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
        document.getElementById(tab).classList.add("active-tab");
        document.getElementById("currentTabTitle").innerText = this.title;
        if (tab === "profile") renderProfile();
        if (tab === "watchlist") renderWatchlist();
        if (tab === "watched") renderWatched();
      });
    });

    function initMainApp() {
      function saveData(mediaList, activityLog, userProfile) {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("activityLog", JSON.stringify(activityLog));
        localStorage.setItem("userProfile", JSON.stringify(userProfile));
      }
      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      let activityLog = JSON.parse(localStorage.getItem("activityLog")) || [];
      let userProfile = JSON.parse(localStorage.getItem("userProfile")) || {
        name: "Default Name",
        image: "https://via.placeholder.com/40"
      };

      window.renderProfile = function() {
        mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        const watchedItems = mediaList.filter(m => m.watched);
        const watchlistItems = mediaList.filter(m => !m.watched);
        const watchedCount = watchedItems.length;
        const watchlistCount = watchlistItems.length;
        const totalWatchHours = watchedItems.reduce((total, item) => total + (parseFloat(item.duration) || 0), 0).toFixed(1);
        const totalRating = watchedItems.reduce((sum, item) => sum + (item.rating || 0), 0);
        const avgRating = watchedCount ? (totalRating / watchedCount).toFixed(1) : "0";
        document.getElementById("profileCardImage").src = userProfile.image;
        document.getElementById("profileCardName").innerText = userProfile.name;
        document.getElementById("profileStats").innerText =
          `Watched: ${watchedCount} | Watchlisted: ${watchlistCount} | Watch Hours: ${totalWatchHours}h | Satisfaction: ${avgRating}`;
      };

      function updateProfileHeader() {
        document.getElementById("profileName").innerText = userProfile.name;
        document.getElementById("profileImage").src = userProfile.image;
      }

      var profileModalEl = document.getElementById('profileModal');
      profileModalEl.addEventListener('show.bs.modal', function () {
        document.getElementById("editName").value = userProfile.name;
        document.getElementById("editImage").value = "";
        document.getElementById("profilePreview").style.display = "none";
      });
      document.getElementById("editImage").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            document.getElementById("profilePreview").src = evt.target.result;
            document.getElementById("profilePreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });
      document.getElementById("saveProfileBtn").addEventListener("click", function () {
        const newName = document.getElementById("editName").value || "Default Name";
        userProfile.name = newName;
        const fileInput = document.getElementById("editImage");
        if (fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            userProfile.image = evt.target.result;
            saveData(mediaList, activityLog, userProfile);
            updateProfileHeader();
            renderProfile();
            var modal = bootstrap.Modal.getInstance(profileModalEl);
            modal.hide();
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          saveData(mediaList, activityLog, userProfile);
          updateProfileHeader();
          renderProfile();
          var modal = bootstrap.Modal.getInstance(profileModalEl);
          modal.hide();
        }
      });

      async function performSearch(query) {
        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          if (data.results && Array.isArray(data.results)) {
            renderSearchResults(data.results);
          } else {
            resultsContainer.innerHTML = `
              <div class='empty-state'>
                <img src='https://via.placeholder.com/400x300.png?text=No+Results' alt='No Results'><br>
                No results found. Try another search!
              </div>
            `;
          }
        } catch (error) {
          console.error("Search error:", error);
          resultsContainer.innerHTML = `
            <div class='empty-state'>
              <img src='https://via.placeholder.com/400x300.png?text=Error' alt='Error'><br>
              Error fetching search results.
            </div>
          `;
        }
      }

      function renderSearchResults(results) {
        const container = document.getElementById("searchResults");
        container.innerHTML = "";
        results.forEach(item => {
          if (item.media_type !== "movie" && item.media_type !== "tv") return;
          const title = (item.media_type === "movie") ? item.title : item.name;
          const date = (item.media_type === "movie") ? item.release_date : item.first_air_date;
          const year = date ? date.substring(0, 4) : "N/A";
          const posterUrl = item.poster_path
            ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
            : "https://via.placeholder.com/200x300.png?text=No+Image";
          const card = document.createElement("div");
          card.className = "search-card";
          card.innerHTML = `
            <img src="${posterUrl}" alt="${title}" loading="lazy"
                 onerror="this.src='https://via.placeholder.com/200x300.png?text=No+Image';">
            <div class="card-body">
              <h5 class="card-title">${title}</h5>
              <p class="card-text"><small>${year}</small></p>
            </div>
          `;
          card.addEventListener("click", function () {
            openDetailsPage(item.id, item.media_type);
          });
          container.appendChild(card);
        });
      }

      function openDetailsPage(id, mediaType) {
        history.pushState({}, "", `?media_type=${mediaType}&id=${id}`);
        document.getElementById("detailsApp").style.display = "block";
        loadDetails(mediaType, id);
      }

      function renderWatchlist() {
        mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        const container = document.getElementById("watchlistContainer");
        const filters = document.getElementById("watchlistFilters");
        let list = mediaList.filter(m => !m.watched);
        if (list.length === 0) {
          filters.style.display = "none";
          container.innerHTML = `
            <div class='empty-state'>
              <img src='https://img.freepik.com/free-vector/open-air-cinema_23-2148644732.jpg?t=st=1742117585~exp=1742121185~hmac=c513ea492b7e3ae44d3cb7b4f7f9682109891a8f07f77d005d94a54b82636bc7&w=996'
                   alt='Empty'>
              <br>Your watchlist is empty. Add some media!
            </div>
          `;
          return;
        } else {
          filters.style.display = "flex";
        }
        const sortOrder = document.getElementById("watchlistSort").value || "release_new";
        list.sort((a, b) => {
          if (sortOrder === "release_new") {
            return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
          } else if (sortOrder === "release_old") {
            return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
          } else if (sortOrder === "recent") {
            return (b.added || 0) - (a.added || 0);
          }
        });
        container.innerHTML = "";
        list.forEach((m) => {
          const extraInfo = (m.media_type === "movie")
            ? `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`
            : "";
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid"
                     style="width:80px; height:120px; object-fit:cover;"
                     onerror="this.src='https://via.placeholder.com/80x120.png?text=No+Image';">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  ${extraInfo}
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                </div>
              </div>
            </div>
          `;
          card.addEventListener("click", function(){
            openDetailsPage(m.id, m.media_type);
          });
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            let updatedList = JSON.parse(localStorage.getItem("mediaList")) || [];
            updatedList = updatedList.filter(item => !(item.id === m.id && item.media_type === m.media_type));
            localStorage.setItem("mediaList", JSON.stringify(updatedList));
            renderWatchlist();
          });
          container.appendChild(card);
        });
      }
      window.renderWatchlist = renderWatchlist;

      function renderWatched() {
        mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        const container = document.getElementById("watchedContainer");
        const filters = document.getElementById("watchedFilters");
        let list = mediaList.filter(m => m.watched);
        if (list.length === 0) {
          filters.style.display = "none";
          container.innerHTML = `
            <div class='empty-state'>
              <img src='https://img.freepik.com/free-vector/hand-drawn-movie-theater-drawing-illustration_23-2151023043.jpg?t=st=1742117582~exp=1742121182~hmac=1f25fce97fa62c661472e2b8a0c29d0a51644115d62b51510a679dbce4d6b121&w=740'
                   alt='Empty'>
              <br>No watched items yet. Time for a movie marathon!
            </div>
          `;
          return;
        } else {
          filters.style.display = "flex";
        }
        const sortOrder = document.getElementById("watchedSort").value || "release_new";
        list.sort((a, b) => {
          if (sortOrder === "release_new") {
            return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
          } else if (sortOrder === "release_old") {
            return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
          } else if (sortOrder === "recent") {
            return (b.added || 0) - (a.added || 0);
          }
        });
        container.innerHTML = "";
        list.forEach((m) => {
          const extraInfo = (m.media_type === "movie")
            ? `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`
            : "";
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid"
                     style="width:80px; height:120px; object-fit:cover;"
                     onerror="this.src='https://via.placeholder.com/80x120.png?text=No+Image';">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  ${extraInfo}
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  <p class="card-text"><small>Rating: ${m.rating} / 5</small></p>
                </div>
              </div>
            </div>
          `;
          card.addEventListener("click", function(){
            openDetailsPage(m.id, m.media_type);
          });
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            let updatedList = JSON.parse(localStorage.getItem("mediaList")) || [];
            updatedList = updatedList.filter(item => !(item.id === m.id && item.media_type === m.media_type));
            localStorage.setItem("mediaList", JSON.stringify(updatedList));
            renderWatched();
          });
          container.appendChild(card);
        });
      }
      window.renderWatched = renderWatched;

      function debounce(func, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), delay);
        };
      }
      document.getElementById("searchQuery").addEventListener("keyup", debounce(function () {
        const query = this.value.trim();
        if (query) performSearch(query);
        else document.getElementById("searchResults").innerHTML = "";
      }, 500));
      document.getElementById("watchlistSort").addEventListener("change", renderWatchlist);
      document.getElementById("watchedSort").addEventListener("change", renderWatched);
      renderWatchlist();
      renderWatched();
      updateProfileHeader();
    }

    function loadDetails(mediaType, id) {
      if (!mediaType || !id) {
        document.getElementById("detailTitle").innerText = "Invalid Item";
        return;
      }
      const apiUrl = (mediaType === "movie")
        ? `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits,seasons`
        : `https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits,seasons`;
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then(details => {
          renderDetails(details, mediaType);
        })
        .catch(error => {
          console.error("Error fetching details:", error);
          document.getElementById("detailTitle").innerText = "Error Loading Details";
        });
    }

    function renderDetails(details, mediaType) {
      const title = (mediaType === "movie") ? details.title : details.name;
      document.getElementById("detailTitle").innerText = title;
      
      // Display only release year below title
      const releaseYear = (details.release_date || details.first_air_date || "").substring(0,4) || "N/A";
      document.getElementById("detailReleaseYear").innerText = releaseYear;
      
      // Director name (for movies) or creator (for TV, if available)
      let director = "N/A";
      if (details.credits && details.credits.crew) {
        const directorObj = details.credits.crew.find(member => member.job === "Director")
                        || details.credits.crew.find(member => member.job === "Executive Producer");
        if (directorObj) director = directorObj.name;
      }
      document.getElementById("detailDirector").innerText = "Director: " + director;
      
      // Additional Info
      let infoHtml = "";
      if (details.genres && details.genres.length > 0) {
        infoHtml += `<p><strong>Genres:</strong> ${details.genres.map(g => g.name).join(', ')}</p>`;
      }
      if (mediaType === "movie") {
        const runtimeHours = details.runtime ? (details.runtime / 60).toFixed(1) + "h" : "N/A";
        infoHtml += `<p><strong>Duration:</strong> ${runtimeHours}</p>`;
      } else if (mediaType === "tv") {
        infoHtml += `<p><strong>Episode Runtime:</strong> ${
          details.episode_run_time && details.episode_run_time.length > 0
            ? details.episode_run_time[0] + " min"
            : "N/A"
        }</p>`;
      }
      infoHtml += `<p><strong>Language:</strong> ${details.original_language || "N/A"}</p>`;
      infoHtml += `<p><strong>TMDB Rating:</strong> ${
        details.vote_average ? details.vote_average.toFixed(1) + " / 10" : "N/A"
      }</p>`;
      document.getElementById("additionalInfo").innerHTML = infoHtml;
      
      // TV Series Info (Seasons/Episodes)
      if (mediaType === "tv" && details.seasons && details.seasons.length > 0) {
        document.getElementById("tvSeriesInfoSection").style.display = "block";
        const seasonDropdown = document.getElementById("seasonDropdown");
        seasonDropdown.innerHTML = "";
        details.seasons.forEach(season => {
          const option = document.createElement("option");
          option.value = season.season_number;
          option.text = season.name + (season.episode_count ? ` (${season.episode_count} episodes)` : "");
          seasonDropdown.appendChild(option);
        });
        // Load episodes for the first season by default
        loadEpisodes(details.id, details.seasons[0].season_number);
        seasonDropdown.addEventListener("change", function() {
          loadEpisodes(details.id, this.value);
        });
      } else {
        document.getElementById("tvSeriesInfoSection").style.display = "none";
      }
      
      // Description
      document.getElementById("detailOverview").innerText = details.overview || "No description available.";
      
      // Poster
      const posterUrl = details.poster_path
        ? `https://image.tmdb.org/t/p/w300${details.poster_path}`
        : "https://via.placeholder.com/300x450.png?text=No+Image";
      document.getElementById("detailPoster").src = posterUrl;
      
      // Prepare currentDetail
      const durationVal = (mediaType === "movie")
        ? (details.runtime ? (details.runtime / 60).toFixed(1) : "0")
        : (details.episode_run_time && details.episode_run_time.length > 0
            ? (details.episode_run_time[0] / 60).toFixed(1)
            : "0");
      currentDetail = {
        id: details.id,
        media_type: mediaType,
        title: title,
        date: details.release_date || details.first_air_date || "",
        poster: posterUrl,
        watched: false,
        rating: null,
        overview: details.overview || "",
        duration: durationVal,
        added: Date.now()
      };
      
      // Cast
      if (details.credits && details.credits.cast) {
        const castList = document.getElementById("castList");
        castList.innerHTML = "";
        details.credits.cast.slice(0, 8).forEach(actor => {
          const castItem = document.createElement("div");
          castItem.className = "cast-item";
          const profileUrl = actor.profile_path
            ? `https://image.tmdb.org/t/p/w185${actor.profile_path}`
            : "https://via.placeholder.com/60.png?text=No+Image";
          castItem.innerHTML = `
            <img src="${profileUrl}" alt="${actor.name}" loading="lazy"
                 onerror="this.src='https://via.placeholder.com/60.png?text=No+Image';">
            <br><span>${actor.name}</span>
          `;
          castList.appendChild(castItem);
        });
      }
      
      // Check if item is saved
      const mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      const found = mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type);
      if (found && !found.watched) {
        document.getElementById("addToWatchlistBtn").style.display = "none";
        document.getElementById("detailsRatingSection").style.display = "block";
        document.getElementById("detailsUserRating").style.display = "none";
      } else if (found && found.watched) {
        document.getElementById("addToWatchlistBtn").style.display = "none";
        document.getElementById("detailsRatingSection").style.display = "none";
        document.getElementById("detailsUserRating").style.display = "block";
        document.getElementById("userRatingValue").innerText = found.rating;
      } else {
        document.getElementById("addToWatchlistBtn").style.display = "block";
        document.getElementById("detailsRatingSection").style.display = "none";
        document.getElementById("detailsUserRating").style.display = "none";
      }
    }

    function loadEpisodes(tvId, seasonNumber) {
      const seasonUrl = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${TMDB_API_KEY}`;
      fetch(seasonUrl)
        .then(response => response.json())
        .then(data => {
          const episodeDropdown = document.getElementById("episodeDropdown");
          episodeDropdown.innerHTML = "";
          if (data.episodes && data.episodes.length > 0) {
            episodeDropdown.disabled = false;
            data.episodes.forEach(episode => {
              const option = document.createElement("option");
              option.value = episode.episode_number;
              option.text = `Ep ${episode.episode_number}: ${episode.name}`;
              episodeDropdown.appendChild(option);
            });
          } else {
            episodeDropdown.innerHTML = "<option>No episodes found</option>";
            episodeDropdown.disabled = true;
          }
        })
        .catch(error => {
          console.error("Error fetching episodes:", error);
          const episodeDropdown = document.getElementById("episodeDropdown");
          episodeDropdown.innerHTML = "<option>Error loading episodes</option>";
          episodeDropdown.disabled = true;
        });
    }

    document.getElementById("addToWatchlistBtn").addEventListener("click", function() {
      if (!currentDetail) return;
      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      const found = mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type);
      if (!found) {
        mediaList.push(currentDetail);
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
      }
      document.getElementById("addToWatchlistBtn").style.display = "none";
      document.getElementById("detailsRatingSection").style.display = "block";
    });

    document.querySelectorAll("#starRatingDetails i").forEach(star => {
      star.addEventListener("click", function() {
        selectedRating = parseInt(this.getAttribute("data-value"));
        document.querySelectorAll("#starRatingDetails i").forEach(s => {
          const val = parseInt(s.getAttribute("data-value"));
          if (val <= selectedRating) s.classList.add("selected");
          else s.classList.remove("selected");
        });
      });
    });

    document.getElementById("submitRatingBtn").addEventListener("click", function() {
      if (!currentDetail) return;
      if (!selectedRating) {
        alert("Please select a star rating first.");
        return;
      }
      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      const index = mediaList.findIndex(item => item.id === currentDetail.id && item.media_type === currentDetail.media_type);
      if (index > -1) {
        mediaList[index].watched = true;
        mediaList[index].rating = selectedRating;
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
      }
      document.getElementById("detailsApp").style.display = "none";
      history.pushState("", document.title, window.location.pathname);
      document.querySelector('.nav-btn[data-tab="watched"]').click();
      selectedRating = 0;
      document.querySelectorAll("#starRatingDetails i").forEach(star => star.classList.remove("selected"));
    });
  </script>
</body>
</html>
