<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Watchlist</title>
    <!-- Google Fonts: Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- FontAwesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Global Styles */
      body {
        background-color: #f0f2f5;
        color: #333;
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
      }
      /* App Container */
      .app-container {
        max-width: 500px;
        margin: 0 auto;
        position: relative;
        min-height: 100vh;
        background: #fff;
      }
      /* Header */
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #fff;
      }
      #currentTabTitle {
        font-size: 1.5rem;
        font-weight: 700;
      }
      /* Profile Container (Name left of image) */
      .profile-container {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      }
      #profileName {
        margin-right: 10px;
        font-weight: 500;
        font-size: 0.9rem;
      }
      #profileImageContainer {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        background-color: #ddd;
      }
      #profileImageContainer img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      /* Content Area */
      .app-content {
        padding: 16px;
        padding-bottom: 80px; /* extra bottom padding for nav */
      }
      .tab {
        display: none;
      }
      .tab.active-tab {
        display: block;
      }
      /* Search Box */
      .search-group {
        margin-bottom: 1rem;
      }
      /* Media Cards */
      .media-card {
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        position: relative;
      }
      .media-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .media-card img {
        width: 80px;
        height: 120px;
        object-fit: cover;
      }
      .media-card .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: #e74c3c;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.3s;
      }
      .media-card .delete-btn:hover {
        opacity: 1;
      }
      /* Modal Image */
      #detailsPoster {
        width: 100%;
        max-width: 300px;
      }
      /* Star Rating */
      .star-rating i {
        font-size: 2rem;
        color: #ccc;
        cursor: pointer;
        transition: transform 0.2s ease, color 0.2s ease;
      }
      .star-rating i.selected {
        color: #f1c40f;
        animation: slideIn 0.3s forwards;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      /* Bottom Navigation */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 500px;
        height: 60px;
        background-color: #fff;
        border-top: 1px solid #e1e4e8;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }
      .nav-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #333;
        cursor: pointer;
        transition: color 0.3s;
      }
      .nav-btn.active {
        color: #1abc9c;
      }
      /* Buttons */
      .btn {
        padding: 0.4rem 0.8rem;
      }
      .mark-btn {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Header -->
      <header class="app-header">
        <h2 id="currentTabTitle">Discover</h2>
        <div id="profileContainer" class="profile-container">
          <span id="profileName" class="d-none d-sm-inline">Default Name</span>
          <div id="profileImageContainer">
            <img id="profileImage" src="https://via.placeholder.com/40" alt="Profile" />
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="app-content">
        <!-- Discover/Search Tab -->
        <div id="search" class="tab active-tab">
          <div class="search-group input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input
              type="text"
              id="searchQuery"
              class="form-control"
              placeholder="Search movies or series..."
            />
          </div>
          <div id="searchResults"></div>
        </div>
        <!-- Watchlist Tab -->
        <div id="watchlist" class="tab">
          <div class="d-flex justify-content-end mb-3">
            <select id="watchlistSort" class="form-select form-select-sm" style="width: auto;">
              <option value="latest">Latest to Oldest</option>
              <option value="oldest">Oldest to Latest</option>
            </select>
          </div>
          <div id="watchlistContainer"></div>
        </div>
        <!-- Watched Tab -->
        <div id="watched" class="tab">
          <div class="d-flex justify-content-end mb-3">
            <select id="watchedSort" class="form-select form-select-sm" style="width: auto;">
              <option value="latest">Latest to Oldest</option>
              <option value="oldest">Oldest to Latest</option>
            </select>
          </div>
          <div id="watchedContainer"></div>
        </div>
      </main>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <button type="button" class="nav-btn active" data-tab="search" title="Discover">
          <i class="fas fa-search"></i>
        </button>
        <button type="button" class="nav-btn" data-tab="watchlist" title="Watchlist">
          <i class="fas fa-bookmark"></i>
        </button>
        <button type="button" class="nav-btn" data-tab="watched" title="Watched">
          <i class="fas fa-eye"></i>
        </button>
      </nav>
    </div>

    <!-- Details Modal for Search Item -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <img id="detailsPoster" src="" alt="" class="img-fluid rounded" />
              </div>
              <div class="col-md-8">
                <p id="detailsOverview"></p>
                <ul class="list-group mb-3">
                  <li class="list-group-item">
                    <strong>Release Date:</strong> <span id="detailsDate"></span>
                  </li>
                  <li class="list-group-item">
                    <strong>Rating:</strong> <span id="detailsRating"></span>
                  </li>
                  <li class="list-group-item" id="detailsGenres"></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="addToWatchlistBtn" class="btn btn-outline-primary btn-sm w-100">
              <i class="fas fa-plus"></i> Add to Watchlist
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rating Modal (for marking as watched) -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ratingModalLabel">Rate (out of 5 stars)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <div id="starRating" class="star-rating">
              <i class="fas fa-star" data-value="1"></i>
              <i class="fas fa-star" data-value="2"></i>
              <i class="fas fa-star" data-value="3"></i>
              <i class="fas fa-star" data-value="4"></i>
              <i class="fas fa-star" data-value="5"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" id="editName" class="form-control" placeholder="Enter your name">
            </div>
            <div class="mb-3">
              <label for="editImage" class="form-label">Profile Image</label>
              <input type="file" id="editImage" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
              <img id="profilePreview" src="" alt="Preview" class="img-fluid rounded" style="max-width:100px; display:none;">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="saveProfileBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JavaScript -->
    <script>
      // IMPORTANT: Replace with your TMDB API key.
      const TMDB_API_KEY = "fa6ceab60f185619e0854acce9f0fcfd";

      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      let activityLog = JSON.parse(localStorage.getItem("activityLog")) || [];

      // User Profile Data stored as name and image (base64 if uploaded)
      let userProfile = JSON.parse(localStorage.getItem("userProfile")) || {
        name: "Default Name",
        image: "https://via.placeholder.com/40"
      };

      function saveData() {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("activityLog", JSON.stringify(activityLog));
        localStorage.setItem("userProfile", JSON.stringify(userProfile));
      }

      // Update Profile Header
      function updateProfileHeader() {
        document.getElementById("profileName").innerText = userProfile.name;
        document.getElementById("profileImage").src = userProfile.image;
      }

      // Bottom Navigation: switch tabs and update header title
      document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", function () {
          document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
          document.getElementById(tab).classList.add("active-tab");
          // Update header title based on button's title attribute
          document.getElementById("currentTabTitle").innerText = this.title;
        });
      });

      // Header Profile Click: Open Profile Edit Modal
      const profileModal = new bootstrap.Modal(document.getElementById("profileModal"));
      document.getElementById("profileContainer").addEventListener("click", function () {
        document.getElementById("editName").value = userProfile.name;
        document.getElementById("editImage").value = "";
        document.getElementById("profilePreview").style.display = "none";
        profileModal.show();
      });

      // Handle image preview on file select
      document.getElementById("editImage").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            document.getElementById("profilePreview").src = evt.target.result;
            document.getElementById("profilePreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      // Save profile changes
      document.getElementById("saveProfileBtn").addEventListener("click", function () {
        const newName = document.getElementById("editName").value || "Default Name";
        userProfile.name = newName;
        const fileInput = document.getElementById("editImage");
        if (fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            userProfile.image = evt.target.result;
            saveData();
            updateProfileHeader();
            profileModal.hide();
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          saveData();
          updateProfileHeader();
          profileModal.hide();
        }
      });

      // TMDB search (movies & TV)
      async function performSearch(query) {
        const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          if (data.results) renderSearchResults(data.results);
          else document.getElementById("searchResults").innerHTML =
            "<p>No results found. Try another search!</p>";
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Render Search Results
      function renderSearchResults(results) {
        const container = document.getElementById("searchResults");
        container.innerHTML = "";
        results.forEach(item => {
          if (item.media_type !== "movie" && item.media_type !== "tv") return;
          const title = item.media_type === "movie" ? item.title : item.name;
          const date = item.media_type === "movie" ? item.release_date : item.first_air_date;
          const year = date ? date.substring(0, 4) : "N/A";
          const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : "https://via.placeholder.com/80x120";
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <div class="row g-0">
              <div class="col-auto">
                <img src="${posterUrl}" alt="${title}" class="img-fluid" />
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                </div>
              </div>
            </div>
          `;
          card.addEventListener("click", function () {
            fetchDetails(item.id, item.media_type);
          });
          container.appendChild(card);
        });
      }

      async function fetchDetails(id, mediaType) {
        let url = "";
        if (mediaType === "movie") {
          url = `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_API_KEY}`;
        } else if (mediaType === "tv") {
          url = `https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}`;
        }
        try {
          const response = await fetch(url);
          const details = await response.json();
          showDetailsModal(details, mediaType);
        } catch (error) {
          console.error("Error fetching details:", error);
        }
      }

      function showDetailsModal(details, mediaType) {
        const title = mediaType === "movie" ? details.title : details.name;
        document.getElementById("detailsModalLabel").innerText = title;
        const posterUrl = details.poster_path ? `https://image.tmdb.org/t/p/w300${details.poster_path}` : "https://via.placeholder.com/300x450";
        document.getElementById("detailsPoster").src = posterUrl;
        document.getElementById("detailsPoster").alt = title;
        document.getElementById("detailsOverview").innerText = details.overview || "No description available.";
        document.getElementById("detailsDate").innerText = details.release_date || details.first_air_date || "N/A";
        document.getElementById("detailsRating").innerText = details.vote_average ? details.vote_average + " / 10" : "N/A";
        if (details.genres && details.genres.length > 0) {
          const genreNames = details.genres.map(g => g.name).join(", ");
          document.getElementById("detailsGenres").innerHTML = "<strong>Genres:</strong> " + genreNames;
        } else {
          document.getElementById("detailsGenres").innerHTML = "";
        }
        currentDetail = {
          id: details.id,
          media_type: mediaType,
          title: title,
          date: details.release_date || details.first_air_date || "",
          poster: posterUrl,
          watched: false,
          rating: null,
          overview: details.overview || ""
        };
        detailsModal.show();
      }

      let currentDetail = null;
      const detailsModal = new bootstrap.Modal(document.getElementById("detailsModal"));

      document.getElementById("addToWatchlistBtn").addEventListener("click", function () {
        if (!currentDetail) return;
        if (!mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type)) {
          mediaList.push(currentDetail);
          saveData();
          renderWatchlist();
        }
        detailsModal.hide();
        document.getElementById("searchQuery").value = "";
        document.getElementById("searchResults").innerHTML = "";
      });

      // Render Watchlist
      function renderWatchlist() {
        const container = document.getElementById("watchlistContainer");
        container.innerHTML = "";
        let list = mediaList.filter(m => !m.watched);
        const sortOrder = document.getElementById("watchlistSort")?.value || "latest";
        list.sort((a, b) => {
          let dateA = new Date(a.date).getTime() || 0;
          let dateB = new Date(b.date).getTime() || 0;
          return sortOrder === "latest" ? dateB - dateA : dateA - dateB;
        });
        if (list.length === 0) {
          container.innerHTML = "<p>Your watchlist is feeling lonely... Add some awesome media!</p>";
          return;
        }
        list.forEach((m, idx) => {
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:80px; height:120px; object-fit:cover;">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  <button class="btn btn-sm btn-outline-secondary mark-btn" data-index="${idx}" style="margin-top:10px;">
                    I Watched It
                  </button>
                </div>
              </div>
            </div>
          `;
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const notWatched = mediaList.filter(m => !m.watched);
            const itemToDelete = notWatched[idx];
            mediaList = mediaList.filter(m => !(m.id === itemToDelete.id && m.media_type === itemToDelete.media_type));
            saveData();
            renderWatchlist();
          });
          card.querySelector(".mark-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const idx = this.getAttribute("data-index");
            openRatingModal(idx);
          });
          container.appendChild(card);
        });
      }

      // Render Watched Items
      function renderWatched() {
        const container = document.getElementById("watchedContainer");
        container.innerHTML = "";
        let list = mediaList.filter(m => m.watched);
        const sortOrder = document.getElementById("watchedSort")?.value || "latest";
        list.sort((a, b) => {
          let dateA = new Date(a.date).getTime() || 0;
          let dateB = new Date(b.date).getTime() || 0;
          return sortOrder === "latest" ? dateB - dateA : dateA - dateB;
        });
        if (list.length === 0) {
          container.innerHTML = "<p>You haven't watched anything yet! How about a movie marathon?</p>";
          return;
        }
        list.forEach((m, idx) => {
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:80px; height:120px; object-fit:cover;">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  <p class="card-text"><small>Rating: ${m.rating} / 5</small></p>
                </div>
              </div>
            </div>
          `;
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const watchedItems = mediaList.filter(m => m.watched);
            const itemToDelete = watchedItems[idx];
            mediaList = mediaList.filter(m => !(m.id === itemToDelete.id && m.media_type === itemToDelete.media_type));
            saveData();
            renderWatched();
          });
          container.appendChild(card);
        });
      }

      // Rating Modal functionality
      let currentMarkIndex = null;
      const ratingModal = new bootstrap.Modal(document.getElementById("ratingModal"));
      function openRatingModal(index) {
        currentMarkIndex = index;
        document.querySelectorAll("#starRating i").forEach(star => star.classList.remove("selected"));
        ratingModal.show();
      }
      document.querySelectorAll("#starRating i").forEach(star => {
        star.addEventListener("click", function () {
          const rating = parseInt(this.getAttribute("data-value"));
          document.querySelectorAll("#starRating i").forEach(s => {
            const val = parseInt(s.getAttribute("data-value"));
            if (val <= rating) s.classList.add("selected");
            else s.classList.remove("selected");
          });
          const notWatched = mediaList.filter(m => !m.watched);
          const item = notWatched[currentMarkIndex];
          const originalIndex = mediaList.findIndex(m => m.id === item.id && m.media_type === item.media_type);
          mediaList[originalIndex].watched = true;
          mediaList[originalIndex].rating = rating;
          saveData();
          ratingModal.hide();
          renderWatchlist();
          renderWatched();
        });
      });

      // Live search with debounce
      function debounce(func, delay) {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), delay);
        };
      }
      document.getElementById("searchQuery").addEventListener("keyup", debounce(function () {
        const query = this.value.trim();
        if (query) performSearch(query);
        else document.getElementById("searchResults").innerHTML = "";
      }, 500));

      // Sort filter listeners
      document.getElementById("watchlistSort").addEventListener("change", renderWatchlist);
      document.getElementById("watchedSort").addEventListener("change", renderWatched);

      // Initial render
      renderWatchlist();
      renderWatched();
      updateProfileHeader();
    </script>
  </body>
</html>
