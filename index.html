<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Media Watchlist</title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #1abc9c;
      --secondary-color: #333;
      --bg-color: #f0f2f5;
      --card-bg: #fff;
      --text-color: #333;
    }
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
      padding-bottom: 80px; /* For fixed bottom navigation */
    }
    /* ------------------ MAIN APP CONTAINER ------------------ */
    .app-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0 16px; /* Added left/right padding */
      position: relative;
      min-height: 100vh;
      background: var(--card-bg);
      z-index: 100;
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e1e4e8;
      background-color: var(--card-bg);
    }
    #currentTabTitle {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .profile-container {
      display: inline-flex;
      align-items: center;
    }
    #profileName {
      margin-right: 10px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    #profileImageContainer {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background-color: #ddd;
    }
    #profileImageContainer img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .app-content {
      padding: 16px 0;
    }
    .tab {
      display: none;
    }
    .tab.active-tab {
      display: block;
    }
    .search-group {
      margin-bottom: 1rem;
    }
    /* ------------------ SEARCH RESULTS (Grid Layout) ------------------ */
    #searchResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .search-card {
      border: none;
      border-radius: 8px;
      overflow: hidden;
      background: var(--card-bg);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .search-card:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-card img {
      width: 100%;
      height: auto;
      display: block;
    }
    .search-card .card-body {
      padding: 0.5rem;
    }
    .search-card .card-title {
      font-size: 1rem;
      margin: 0;
      font-weight: 500;
    }
    .search-card .card-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.25rem;
    }
    /* ------------------ WATCHLIST / WATCHED CARDS ------------------ */
    .media-card {
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      background: var(--card-bg);
      position: relative;
    }
    .media-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .media-card img {
      width: 80px;
      height: 120px;
      object-fit: cover;
    }
    .media-card .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 1rem;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    .media-card .delete-btn:hover {
      opacity: 1;
    }
    /* ------------------ PROFILE CARD ------------------ */
    .profile-card {
      position: relative;
      border: 1px solid #e1e4e8;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin-top: 20px;
      background: var(--card-bg);
    }
    .profile-card .edit-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2rem;
      color: var(--primary-color);
      cursor: pointer;
    }
    .profile-card .profile-img {
      width: 100px;
      height: 100px;
      margin: 0 auto 10px;
      border-radius: 50%;
      overflow: hidden;
      background-color: #ddd;
    }
    .profile-card .profile-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-card .profile-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .profile-card .profile-stats {
      font-size: 0.9rem;
      color: #555;
    }
    /* ------------------ DETAILS VIEW (Overlay) ------------------ */
    #detailsApp {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background: var(--card-bg);
      z-index: 200;
      padding: 20px;
      display: none;
    }
    .details-container {
      max-width: 500px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding-bottom: 60px;
    }
    .details-header {
      text-align: center;
      position: relative;
      padding: 20px 0;
    }
    .details-poster {
      width: 180px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-add-watchlist {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 16px;
      border-radius: 50%;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      position: absolute;
      right: 20px;
      top: 20px;
      transition: background-color 0.3s;
    }
    .btn-add-watchlist:hover {
      background-color: #17a589;
    }
    .details-title {
      font-size: 1.8em;
      margin: 10px 0;
      color: var(--secondary-color);
      text-align: center;
    }
    .details-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.95em;
      padding: 12px 0;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
    .details-meta div {
      flex: 1;
      min-width: 45%;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    .details-description {
      padding-top: 10px;
      font-size: 0.95em;
      color: #555;
    }
    .details-cast {
      margin-top: 15px;
    }
    .details-cast-list {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .cast-item {
      text-align: center;
      flex: 0 0 auto;
    }
    .cast-item img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    /* ------------------ FIXED BOTTOM NAVIGATION ------------------ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 500px;
      height: 60px;
      background-color: var(--card-bg);
      border-top: 1px solid #e1e4e8;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 300;
    }
    .nav-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--secondary-color);
      cursor: pointer;
      transition: color 0.3s;
    }
    .nav-btn.active {
      color: var(--primary-color);
    }
    /* ------------------ LOADING SPINNER ------------------ */
    .spinner {
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- MAIN APP VIEW -->
  <div id="mainApp" class="app-container">
    <!-- Header -->
    <header class="app-header">
      <h2 id="currentTabTitle">Search</h2>
      <div id="profileContainer" class="profile-container">
        <span id="profileName" class="d-none d-sm-inline">Default Name</span>
        <div id="profileImageContainer">
          <img id="profileImage" src="https://via.placeholder.com/40" alt="Profile" loading="lazy" />
        </div>
      </div>
    </header>
    <!-- Content -->
    <main class="app-content">
      <!-- Watchlist Tab -->
      <div id="watchlist" class="tab">
        <div class="d-flex justify-content-end mb-3">
          <select id="watchlistSort" class="form-select form-select-sm" style="width: auto;">
            <option value="release_new">Release Date: Newest First</option>
            <option value="release_old">Release Date: Oldest First</option>
            <option value="recent">Recently Added</option>
          </select>
        </div>
        <div id="watchlistContainer"></div>
      </div>
      <!-- Search Tab -->
      <div id="search" class="tab active-tab">
        <div class="search-group input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" id="searchQuery" class="form-control" placeholder="Search movies or series..." />
        </div>
        <div id="searchResults"></div>
      </div>
      <!-- Watched Tab -->
      <div id="watched" class="tab">
        <div class="d-flex justify-content-end mb-3">
          <select id="watchedSort" class="form-select form-select-sm" style="width: auto;">
            <option value="release_new">Release Date: Newest First</option>
            <option value="release_old">Release Date: Oldest First</option>
            <option value="recent">Recently Added</option>
          </select>
        </div>
        <div id="watchedContainer"></div>
      </div>
      <!-- Profile Tab -->
      <div id="profile" class="tab">
        <div class="profile-card">
          <div class="edit-icon" id="profileEditBtn">
            <i class="fas fa-pencil-alt"></i>
          </div>
          <div class="profile-img">
            <img id="profileCardImage" src="https://via.placeholder.com/100" alt="Profile" loading="lazy" />
          </div>
          <h4 class="profile-name" id="profileCardName">Default Name</h4>
          <p class="profile-stats" id="profileStats">
            Watched: 0 | Watchlisted: 0 | Watch Hours: 0h | Satisfaction: 0
          </p>
        </div>
      </div>
    </main>
    <!-- Edit Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" id="editName" class="form-control" placeholder="Enter your name">
            </div>
            <div class="mb-3">
              <label for="editImage" class="form-label">Profile Image</label>
              <input type="file" id="editImage" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
              <img id="profilePreview" src="" alt="Preview" class="img-fluid rounded" style="max-width:100px; display:none;">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="saveProfileBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ratingModalLabel">Rate This Media</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="starRating" class="d-flex justify-content-center">
              <i class="fas fa-star" data-value="1" style="cursor:pointer;"></i>
              <i class="fas fa-star" data-value="2" style="cursor:pointer;"></i>
              <i class="fas fa-star" data-value="3" style="cursor:pointer;"></i>
              <i class="fas fa-star" data-value="4" style="cursor:pointer;"></i>
              <i class="fas fa-star" data-value="5" style="cursor:pointer;"></i>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS VIEW (Overlay) -->
  <div id="detailsApp">
    <div class="details-container">
      <div class="details-header">
        <img id="detailPoster" class="details-poster" src="" alt="Poster" loading="lazy">
        <!-- Plus button now only shows a plus icon -->
        <button class="btn-add-watchlist" id="addToWatchlistBtn">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <h1 id="detailTitle" class="details-title"></h1>
      <div class="details-meta" id="detailMeta">
        <div id="detailDate"><strong>Release:</strong> </div>
        <div id="detailGenres"><strong>Genres:</strong> </div>
        <div id="detailDuration"><strong>Duration:</strong> </div>
        <div id="detailDirector"><strong>Director:</strong> </div>
        <div id="detailLanguage"><strong>Language:</strong> </div>
        <div id="detailRating"><strong>Rating:</strong> </div>
      </div>
      <div class="details-description">
        <h3>Description</h3>
        <p id="detailOverview"></p>
      </div>
      <div class="details-cast">
        <h3>Cast</h3>
        <div id="castList" class="details-cast-list"></div>
      </div>
    </div>
  </div>

  <!-- FIXED BOTTOM NAVIGATION -->
  <nav class="bottom-nav">
    <button type="button" class="nav-btn" data-tab="watchlist" title="Watchlist">
      <i class="fas fa-bookmark"></i>
    </button>
    <button type="button" class="nav-btn active" data-tab="search" title="Search">
      <i class="fas fa-search"></i>
    </button>
    <button type="button" class="nav-btn" data-tab="watched" title="Watched">
      <i class="fas fa-eye"></i>
    </button>
    <button type="button" class="nav-btn" data-tab="profile" title="Profile">
      <i class="fas fa-user"></i>
    </button>
  </nav>

  <!-- ===================== SCRIPTS ===================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Replace with your valid TMDB API key
    const TMDB_API_KEY = "fa6ceab60f185619e0854acce9f0fcfd";
    let currentDetail = null;
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const mediaTypeParam = urlParams.get("media_type");
    const idParam = urlParams.get("id");

    // Always initialize the main app (it remains visible in the background)
    initMainApp();

    // If details parameters exist, display the details view as an overlay
    if (mediaTypeParam && idParam) {
      document.getElementById("detailsApp").style.display = "block";
      loadDetails(mediaTypeParam, idParam);
    } else {
      document.getElementById("detailsApp").style.display = "none";
    }

    /* -------------------- GLOBAL BOTTOM NAVIGATION HANDLER -------------------- */
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        // Hide details overlay if visible
        if (document.getElementById("detailsApp").style.display === "block") {
          document.getElementById("detailsApp").style.display = "none";
          history.pushState("", document.title, window.location.pathname);
        }
        // Remove active class from all nav buttons
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        // Switch active tab
        const tab = this.getAttribute("data-tab");
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
        document.getElementById(tab).classList.add("active-tab");
        document.getElementById("currentTabTitle").innerText = this.title;
        // If switching to profile, update profile info
        if(tab === "profile" && typeof renderProfile === "function") renderProfile();
      });
    });

    /* -------------------- MAIN APP FUNCTIONS -------------------- */
    function initMainApp() {
      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      let activityLog = JSON.parse(localStorage.getItem("activityLog")) || [];
      let userProfile = JSON.parse(localStorage.getItem("userProfile")) || {
        name: "Default Name",
        image: "https://via.placeholder.com/40"
      };

      function saveData() {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("activityLog", JSON.stringify(activityLog));
        localStorage.setItem("userProfile", JSON.stringify(userProfile));
      }

      window.renderProfile = function() {
        const watchedItems = mediaList.filter(m => m.watched);
        const watchlistItems = mediaList.filter(m => !m.watched);
        const watchedCount = watchedItems.length;
        const watchlistCount = watchlistItems.length;
        const totalWatchHours = watchedItems.reduce((total, item) => total + (parseFloat(item.duration) || 0), 0).toFixed(1);
        const totalRating = watchedItems.reduce((sum, item) => sum + (item.rating || 0), 0);
        const avgRating = watchedCount ? (totalRating / watchedCount).toFixed(1) : "0";
        document.getElementById("profileCardImage").src = userProfile.image;
        document.getElementById("profileCardName").innerText = userProfile.name;
        document.getElementById("profileStats").innerText =
          `Watched: ${watchedCount} | Watchlisted: ${watchlistCount} | Watch Hours: ${totalWatchHours}h | Satisfaction: ${avgRating}`;
      }

      function updateProfileHeader() {
        document.getElementById("profileName").innerText = userProfile.name;
        document.getElementById("profileImage").src = userProfile.image;
      }

      // Profile Edit Modal
      const profileModal = new bootstrap.Modal(document.getElementById("profileModal"));
      document.getElementById("profileEditBtn").addEventListener("click", function () {
        document.getElementById("editName").value = userProfile.name;
        document.getElementById("editImage").value = "";
        document.getElementById("profilePreview").style.display = "none";
        profileModal.show();
      });

      document.getElementById("editImage").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            document.getElementById("profilePreview").src = evt.target.result;
            document.getElementById("profilePreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById("saveProfileBtn").addEventListener("click", function () {
        const newName = document.getElementById("editName").value || "Default Name";
        userProfile.name = newName;
        const fileInput = document.getElementById("editImage");
        if (fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            userProfile.image = evt.target.result;
            saveData();
            updateProfileHeader();
            renderProfile();
            profileModal.hide();
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          saveData();
          updateProfileHeader();
          renderProfile();
          profileModal.hide();
        }
      });

      async function performSearch(query) {
        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          if (data.results && Array.isArray(data.results)) {
            renderSearchResults(data.results);
          } else {
            resultsContainer.innerHTML = "<p>No results found. Try another search!</p>";
          }
        } catch (error) {
          console.error("Search error:", error);
          resultsContainer.innerHTML = "<p>Error fetching search results.</p>";
        }
      }

      function renderSearchResults(results) {
        const container = document.getElementById("searchResults");
        container.innerHTML = "";
        results.forEach(item => {
          if (item.media_type !== "movie" && item.media_type !== "tv") return;
          const title = item.media_type === "movie" ? item.title : item.name;
          const date = item.media_type === "movie" ? item.release_date : item.first_air_date;
          const year = date ? date.substring(0, 4) : "N/A";
          const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : "https://via.placeholder.com/200x300";
          const card = document.createElement("div");
          card.className = "search-card";
          card.innerHTML = `
            <img src="${posterUrl}" alt="${title}" loading="lazy" />
            <div class="card-body">
              <h5 class="card-title">${title}</h5>
              <p class="card-text"><small>${year}</small></p>
            </div>
          `;
          card.addEventListener("click", function () {
            openDetailsPage(item.id, item.media_type);
          });
          container.appendChild(card);
        });
      }

      function openDetailsPage(id, mediaType) {
        // Update URL parameters without reloading the page
        history.pushState({}, "", `?media_type=${mediaType}&id=${id}`);
        document.getElementById("detailsApp").style.display = "block";
        loadDetails(mediaType, id);
      }

      function renderWatchlist() {
        const container = document.getElementById("watchlistContainer");
        container.innerHTML = "";
        let list = mediaList.filter(m => !m.watched);
        const sortOrder = document.getElementById("watchlistSort").value || "release_new";
        list.sort((a, b) => {
          if(sortOrder === "release_new") {
            return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
          } else if(sortOrder === "release_old") {
            return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
          } else if(sortOrder === "recent") {
            return (b.added || 0) - (a.added || 0);
          }
        });
        if (list.length === 0) {
          container.innerHTML = "<p>Your watchlist is feeling lonely... Add some awesome media!</p>";
          return;
        }
        list.forEach((m, idx) => {
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          let extraInfo = "";
          if(m.media_type === "tv") {
            extraInfo = `<p class="card-text"><small>Seasons: ${m.seasons || "N/A"} | Episodes: ${m.episodes || "N/A"}</small></p>`;
          } else {
            extraInfo = `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`;
          }
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:80px; height:120px; object-fit:cover;" loading="lazy">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  ${extraInfo}
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  <button class="btn btn-sm btn-outline-secondary mark-btn" data-index="${idx}" style="margin-top:10px;">I Watched It</button>
                </div>
              </div>
            </div>
          `;
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const notWatched = mediaList.filter(m => !m.watched);
            const itemToDelete = notWatched[idx];
            mediaList = mediaList.filter(m => !(m.id === itemToDelete.id && m.media_type === itemToDelete.media_type));
            saveData();
            renderWatchlist();
          });
          card.querySelector(".mark-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const idx = this.getAttribute("data-index");
            openRatingModal(idx);
          });
          container.appendChild(card);
        });
      }

      function renderWatched() {
        const container = document.getElementById("watchedContainer");
        container.innerHTML = "";
        let list = mediaList.filter(m => m.watched);
        const sortOrder = document.getElementById("watchedSort").value || "release_new";
        list.sort((a, b) => {
          if(sortOrder === "release_new") {
            return (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0);
          } else if(sortOrder === "release_old") {
            return (new Date(a.date).getTime() || 0) - (new Date(b.date).getTime() || 0);
          } else if(sortOrder === "recent") {
            return (b.added || 0) - (a.added || 0);
          }
        });
        if (list.length === 0) {
          container.innerHTML = "<p>You haven't watched anything yet! How about a movie marathon?</p>";
          return;
        }
        list.forEach((m, idx) => {
          const year = m.date ? m.date.substring(0, 4) : "N/A";
          let extraInfo = "";
          if(m.media_type === "tv") {
            extraInfo = `<p class="card-text"><small>Seasons: ${m.seasons || "N/A"} | Episodes: ${m.episodes || "N/A"}</small></p>`;
          } else {
            extraInfo = `<p class="card-text"><small>Duration: ${m.duration || "N/A"}h</small></p>`;
          }
          const card = document.createElement("div");
          card.className = "card mb-3 media-card";
          card.innerHTML = `
            <button class="btn btn-link delete-btn"><i class="fas fa-trash-alt"></i></button>
            <div class="row g-0">
              <div class="col-auto">
                <img src="${m.poster}" alt="${m.title}" class="img-fluid" style="width:80px; height:120px; object-fit:cover;" loading="lazy">
              </div>
              <div class="col">
                <div class="card-body">
                  <h5 class="card-title">${m.title}</h5>
                  <p class="card-text"><small>${year}</small></p>
                  ${extraInfo}
                  <p class="card-text"><small>${m.overview || "No synopsis available."}</small></p>
                  <p class="card-text"><small>Rating: ${m.rating} / 5</small></p>
                </div>
              </div>
            </div>
          `;
          card.querySelector(".delete-btn").addEventListener("click", function (e) {
            e.stopPropagation();
            const watchedItems = mediaList.filter(m => m.watched);
            const itemToDelete = watchedItems[idx];
            mediaList = mediaList.filter(m => !(m.id === itemToDelete.id && m.media_type === itemToDelete.media_type));
            saveData();
            renderWatched();
          });
          container.appendChild(card);
        });
      }

      let currentMarkIndex = null;
      const ratingModal = new bootstrap.Modal(document.getElementById("ratingModal"));
      function openRatingModal(index) {
        currentMarkIndex = index;
        document.querySelectorAll("#starRating i").forEach(star => star.classList.remove("selected"));
        ratingModal.show();
      }
      document.querySelectorAll("#starRating i").forEach(star => {
        star.addEventListener("click", function () {
          const rating = parseInt(this.getAttribute("data-value"));
          document.querySelectorAll("#starRating i").forEach(s => {
            const val = parseInt(s.getAttribute("data-value"));
            if (val <= rating) s.classList.add("selected");
            else s.classList.remove("selected");
          });
          const notWatched = mediaList.filter(m => !m.watched);
          const item = notWatched[currentMarkIndex];
          const originalIndex = mediaList.findIndex(m => m.id === item.id && m.media_type === item.media_type);
          mediaList[originalIndex].watched = true;
          mediaList[originalIndex].rating = rating;
          saveData();
          ratingModal.hide();
          renderWatchlist();
          renderWatched();
        });
      });

      function debounce(func, delay) {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), delay);
        };
      }
      document.getElementById("searchQuery").addEventListener("keyup", debounce(function () {
        const query = this.value.trim();
        if (query) performSearch(query);
        else document.getElementById("searchResults").innerHTML = "";
      }, 500));

      document.getElementById("watchlistSort").addEventListener("change", renderWatchlist);
      document.getElementById("watchedSort").addEventListener("change", renderWatched);

      renderWatchlist();
      renderWatched();
      updateProfileHeader();
    }

    /* -------------------- DETAILS VIEW FUNCTIONS -------------------- */
    function loadDetails(mediaType, id) {
      if (!mediaType || !id) {
        document.getElementById("detailTitle").innerText = "Invalid Item";
        return;
      }
      let apiUrl = "";
      if (mediaType === "movie") {
        apiUrl = `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits`;
      } else if (mediaType === "tv") {
        apiUrl = `https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}&append_to_response=credits`;
      }
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then(details => {
          renderDetails(details, mediaType);
        })
        .catch(error => {
          console.error("Error fetching details:", error);
          document.getElementById("detailTitle").innerText = "Error Loading Details";
        });
    }
    function renderDetails(details, mediaType) {
      const title = mediaType === "movie" ? details.title : details.name;
      document.getElementById("detailTitle").innerText = title;
      document.getElementById("detailDate").innerHTML = `<strong>Release:</strong> ${details.release_date || details.first_air_date || "N/A"}`;
      if (details.genres && details.genres.length > 0) {
        const genreNames = details.genres.map(g => g.name).join(', ');
        document.getElementById("detailGenres").innerHTML = `<strong>Genres:</strong> ${genreNames}`;
      } else {
        document.getElementById("detailGenres").innerHTML = `<strong>Genres:</strong> N/A`;
      }
      document.getElementById("detailDuration").innerHTML = `<strong>Duration:</strong> ${
        mediaType === "movie" ? (details.runtime ? (details.runtime / 60).toFixed(1) + "h" : "N/A") : 
        (details.episode_run_time && details.episode_run_time.length > 0 ? (details.episode_run_time[0] / 60).toFixed(1) + "h" : "N/A")
      }`;
      let director = "N/A";
      if(details.credits && details.credits.crew) {
        const directorObj = details.credits.crew.find(member => member.job === "Director");
        if (directorObj) {
          director = directorObj.name;
        }
      }
      document.getElementById("detailDirector").innerHTML = `<strong>Director:</strong> ${director}`;
      document.getElementById("detailLanguage").innerHTML = `<strong>Language:</strong> ${details.original_language || "N/A"}`;
      document.getElementById("detailRating").innerHTML = `<strong>Rating:</strong> ${details.vote_average ? details.vote_average + " / 10" : "N/A"}`;
      const posterUrl = details.poster_path ? `https://image.tmdb.org/t/p/w300${details.poster_path}` : 'https://via.placeholder.com/300x450';
      document.getElementById("detailPoster").src = posterUrl;
      
      document.getElementById("detailOverview").innerText = details.overview || "No description available.";

      let durationVal = mediaType === "movie" 
        ? (details.runtime ? (details.runtime / 60).toFixed(1) : "0")
        : (details.episode_run_time && details.episode_run_time.length > 0 ? (details.episode_run_time[0] / 60).toFixed(1) : "0");
      currentDetail = {
        id: details.id,
        media_type: mediaType,
        title: title,
        date: details.release_date || details.first_air_date || "",
        poster: posterUrl,
        watched: false,
        rating: null,
        overview: details.overview || "",
        duration: durationVal,
        added: Date.now()
      };
      if(mediaType === "tv") {
        currentDetail.seasons = details.number_of_seasons || 0;
        currentDetail.episodes = details.number_of_episodes || 0;
      }
      
      // Render cast
      let castArray = [];
      if(details.credits && details.credits.cast) {
        castArray = details.credits.cast.slice(0, 8);
      }
      const castList = document.getElementById("castList");
      castList.innerHTML = "";
      castArray.forEach(actor => {
        const castItem = document.createElement("div");
        castItem.className = "cast-item";
        const profileUrl = actor.profile_path ? `https://image.tmdb.org/t/p/w185${actor.profile_path}` : 'https://via.placeholder.com/60';
        castItem.innerHTML = `
          <img src="${profileUrl}" alt="${actor.name}" loading="lazy">
          <span>${actor.name}</span>
        `;
        castList.appendChild(castItem);
      });
    }
    // Modified Add to Watchlist: saves the item and then switches to the Watchlist tab
    document.getElementById("addToWatchlistBtn").addEventListener("click", function () {
      if (!currentDetail) return;
      let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
      if (!mediaList.find(m => m.id === currentDetail.id && m.media_type === currentDetail.media_type)) {
        mediaList.push(currentDetail);
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
      }
      // Hide details overlay and update URL
      document.getElementById("detailsApp").style.display = "none";
      history.pushState("", document.title, window.location.pathname);
      // Automatically switch to the Watchlist tab
      document.querySelector('.nav-btn[data-tab="watchlist"]').click();
    });
  </script>
</body>
</html>
